name: Deploy Website

on:
  repository_dispatch:
    types: [deploy_website]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        env:
          TENANT_ID: ${{ github.event.client_payload.tenant_id }}
          DIRECTUS_TOKEN: ${{ secrets.DIRECTUS_TOKEN }}
          DIRECTUS_URL: https://directus.pulpo.cloud
        run: |
          echo "Tenant ID is: $TENANT_ID"
          pnpm run build

      - name: Archive Production Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ github.event.client_payload.tenant_id }}
          path: dist/
          retention-days: 5

      - name: Deploy via Rsync (Best Practice)
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: deployer
          DOMAIN: buho.pulpo.cloud
        run: |
          # --- SSH Setup ---
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts

          # --- Deploy HTML ---
          # -a: archive mode (erhält Rechte/Zeitstempel)
          # -v: verbose
          # -z: compression
          # --delete: Löscht Dateien auf dem Server, die im Build nicht mehr existieren
          rsync -avz --delete -e "ssh -i ~/.ssh/id_ed25519" dist/ $SSH_USER@$SSH_HOST:/opt/stack/www/$DOMAIN/

          # --- Deploy Traefik Config ---
          # rsync -avz -e "ssh -i ~/.ssh/id_ed25519" tenant-*.yml $SSH_USER@$SSH_HOST:/opt/stack/traefik_dynamic/
