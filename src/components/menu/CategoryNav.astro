---
import type { CollectionEntry } from "astro:content";
import { t } from "../../utils/t";

type Category = CollectionEntry<"categories">["data"];
interface Props {
  categories: Category[];
}

const { lang = "" } = Astro.params;
const { categories } = Astro.props;
---

<nav
  id="category-nav"
  class="sticky top-16 z-30 w-full bg-background/90 backdrop-blur-xl border-b border-white/10 shadow-lg"
>
  <div class="w-full overflow-x-auto scrollbar-hide py-3">
    <div
      class="min-w-full w-max flex justify-center"
      style="touch-action: pan-x;"
    >
      <ul class="flex items-center gap-2 px-4 md:px-0">
        {
          categories.map((category, index) => (
            <li class="shrink-0">
              <a
                href={`#${category.id}`}
                class={`category-link block px-4 py-1.5 rounded-full border transition-all duration-300 text-[10px] uppercase tracking-[0.15em] font-medium
                ${index === 0 ? "active" : ""}`}
                data-target={category.id}
              >
                {t(category.name, lang)}
              </a>
            </li>
          ))
        }
      </ul>
    </div>
  </div>
</nav>

<style>
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .category-link {
    background-color: rgba(255, 255, 255, 0.02);
    border-color: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.5);
    -webkit-tap-highlight-color: transparent;
  }

  .category-link:not(.active):hover {
    border-color: rgba(255, 255, 255, 0.3);
    color: white;
  }

  .category-link.active {
    background-color: rgb(253, 230, 138) !important;
    border-color: rgb(253, 230, 138) !important;
    color: black !important;
    font-weight: 700;
    box-shadow: 0 0 10px rgba(253, 230, 138, 0.2);
    transform: scale(1.02);
  }
</style>

<script>
  function initScrollSpy() {
    const navLinks = document.querySelectorAll(".category-link");
    const sections = document.querySelectorAll("section[id]");
    const navContainer = document.querySelector(".overflow-x-auto");

    const SCROLL_OFFSET = 180;

    if (sections.length === 0) return;

    navLinks.forEach((link) => {
      link.addEventListener("click", (e) => {
        e.preventDefault();
        const targetId = link.getAttribute("href")?.substring(1);
        if (!targetId) return;

        const targetSection = document.getElementById(targetId);
        if (targetSection) {
          const top =
            targetSection.getBoundingClientRect().top +
            window.scrollY -
            SCROLL_OFFSET;

          window.scrollTo({
            top: top,
            behavior: "smooth",
          });

          setActiveLink(targetId);
        }
      });
    });

    const observerOptions = {
      root: null,
      rootMargin: `-${SCROLL_OFFSET}px 0px -60% 0px`,
      threshold: 0,
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          setActiveLink(entry.target.id);
        }
      });
    }, observerOptions);

    sections.forEach((section) => observer.observe(section));

    function setActiveLink(id: string) {
      document
        .querySelector(".category-link.active")
        ?.classList.remove("active");

      const activeLink = document.querySelector(
        `.category-link[href="#${id}"]`
      );

      if (activeLink) {
        activeLink.classList.add("active");

        activeLink.scrollIntoView({
          behavior: "smooth",
          block: "nearest",
          inline: "center",
        });
      }
    }
  }

  initScrollSpy();
  document.addEventListener("astro:page-load", initScrollSpy);
</script>
