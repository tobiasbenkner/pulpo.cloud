---
import { defaultLang, languages } from "../../i18n";
const { lang = defaultLang } = Astro.params;

const translations = {
  es: {
    home: "Inicio",
    menu: "Menú",
    contact: "Contacto",
    selectLang: "Idioma",
  },
  en: {
    home: "Home",
    menu: "Menu",
    contact: "Contact",
    selectLang: "Language",
  },
  de: { home: "Home", menu: "Menü", contact: "Kontakt", selectLang: "Sprache" },
};

const t = translations[lang as keyof typeof translations] || translations.es;

const navLinks = [
  { name: t.home, href: `/${lang}/` },
  { name: t.menu, href: `/${lang}/menu` },
  { name: t.contact, href: `/${lang}/contact` },
];

const currentLangObj = languages.find((l) => l.code === lang) || languages[0];

const currentPath = Astro.url.pathname;
const getPathForLang = (newLang: string) => {
  const parts = currentPath.split("/").filter(Boolean);
  if (parts.length > 0 && languages.some((l) => l.code === parts[0])) {
    parts[0] = newLang;
    return "/" + parts.join("/");
  }
  return `/${newLang}/`;
};
---

<header class="bg-background border-b border-border sticky top-0 z-50">
  <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative" aria-label="Top">
    <div class="flex justify-between items-center h-16">
      <!-- 1. Logo (Links) -->
      <div class="flex-1 flex justify-start">
        <a href={`/${lang}/`} class="transition-opacity hover:opacity-80">
          <img src="/logo.webp" alt="Logo" class="h-10" />
        </a>
      </div>

      <!-- 2. Desktop Navigation (Zentriert) -->
      <div class="hidden md:flex flex-1 justify-center space-x-8 items-center">
        {
          navLinks.map((link) => (
            <a
              href={link.href}
              class="text-sm font-medium hover:text-primary transition-colors"
            >
              {link.name}
            </a>
          ))
        }
      </div>

      <!-- 3. Desktop Language Dropdown (Rechts) -->
      <div class="hidden md:flex flex-1 justify-end items-center">
        <div class="relative inline-block text-left" id="lang-dropdown-wrapper">
          <button
            type="button"
            id="lang-button"
            class="flex items-center gap-2 px-3 py-2 text-sm font-medium border border-border rounded-md hover:bg-muted transition-colors uppercase"
          >
            <span>{currentLangObj.flag}</span>
            {currentLangObj.code}
            <svg
              class="w-4 h-4 opacity-50"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>

          <div
            id="lang-menu"
            class="hidden absolute right-0 mt-2 w-40 origin-top-right bg-background border border-border rounded-md shadow-xl z-50"
          >
            <div class="py-1">
              {
                languages.map((l) => (
                  <a
                    href={getPathForLang(l.code)}
                    class={`flex items-center gap-3 px-4 py-2 text-sm hover:bg-muted ${lang === l.code ? "text-primary font-bold" : "text-foreground"}`}
                  >
                    <span>{l.flag}</span>
                    {l.label}
                  </a>
                ))
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Mobile Menu Button -->
      <div class="md:hidden flex items-center">
        <button
          id="menu-toggle"
          type="button"
          class="p-2 hover:text-primary focus:outline-none"
        >
          <svg
            id="menu-icon"
            class="h-7 w-7"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
          <svg
            id="close-icon"
            class="h-7 w-7 hidden"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Menu -->
    <div
      id="mobile-menu"
      class="hidden md:hidden absolute top-16 left-0 right-0 bg-background border-b border-border shadow-xl z-50 max-h-[calc(100vh-64px)] overflow-y-auto"
    >
      <div class="flex flex-col space-y-1 py-4">
        {
          navLinks.map((link) => (
            <a
              href={link.href}
              class="block px-4 py-2 text-lg font-medium hover:bg-muted rounded-md"
            >
              {link.name}
            </a>
          ))
        }

        <div class="pt-4 mt-2 border-t border-border px-4 pb-6">
          <div class="grid grid-cols-1 gap-2">
            {
              languages.map((l) => (
                <a
                  href={getPathForLang(l.code)}
                  class={`flex items-center gap-3 py-2 text-base ${lang === l.code ? "text-primary font-bold" : "text-foreground"}`}
                >
                  <span class="text-xl">{l.flag}</span>
                  {l.label}
                </a>
              ))
            }
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>

<script>
  const menuToggle = document.getElementById("menu-toggle");
  const mobileMenu = document.getElementById("mobile-menu");
  const menuIcon = document.getElementById("menu-icon");
  const closeIcon = document.getElementById("close-icon");

  function closeMobileMenu() {
    mobileMenu?.classList.add("hidden");
    menuIcon?.classList.remove("hidden");
    closeIcon?.classList.add("hidden");
  }

  menuToggle?.addEventListener("click", (e) => {
    e.stopPropagation();
    mobileMenu?.classList.toggle("hidden");
    menuIcon?.classList.toggle("hidden");
    closeIcon?.classList.toggle("hidden");
  });

  const langButton = document.getElementById("lang-button");
  const langMenu = document.getElementById("lang-menu");

  langButton?.addEventListener("click", (e) => {
    e.stopPropagation();
    langMenu?.classList.toggle("hidden");
    const isExpanded = !langMenu?.classList.contains("hidden");
    langButton.setAttribute("aria-expanded", isExpanded.toString());
  });

  document.addEventListener("click", (event) => {
    const target = event.target as Node;

    if (!langButton?.contains(target) && !langMenu?.contains(target)) {
      langMenu?.classList.add("hidden");
      langButton?.setAttribute("aria-expanded", "false");
    }

    if (
      !mobileMenu?.classList.contains("hidden") &&
      !menuToggle?.contains(target) &&
      !mobileMenu?.contains(target)
    ) {
      closeMobileMenu();
    }
  });
</script>
