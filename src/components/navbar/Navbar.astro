---
import { defaultLang, languages } from "../../i18n";
const { lang = defaultLang } = Astro.params;

const translations = {
  es: { home: "Inicio", menu: "Menú", contact: "Contacto" },
  en: { home: "Home", menu: "Menu", contact: "Contact" },
  de: { home: "Start", menu: "Menü", contact: "Kontakt" },
};

const t = translations[lang as keyof typeof translations] || translations.es;

const navLinks = [
  { name: t.home, href: `/${lang}/` },
  { name: t.menu, href: `/${lang}/menu` },
  { name: t.contact, href: `/${lang}/contact` },
];

const currentLangObj = languages.find((l) => l.code === lang) || languages[0];
const currentPath = Astro.url.pathname;

const isActive = (href: string) => {
  const normalize = (path: string) => path.replace(/\/$/, "");
  return normalize(currentPath) === normalize(href);
};

const getPathForLang = (newLang: string) => {
  const parts = currentPath.split("/").filter(Boolean);
  if (parts.length > 0 && languages.some((l) => l.code === parts[0])) {
    parts[0] = newLang;
    return "/" + parts.join("/");
  }
  return `/${newLang}/`;
};
---

<header
  id="main-header"
  class="fixed top-0 left-0 w-full z-50 transition-all duration-300 border-b border-white/5 bg-[#0a0a0a]/80 backdrop-blur-md"
>
  <nav class="max-w-7xl mx-auto px-6" aria-label="Top">
    <div class="flex justify-between items-center h-20">
      <!-- 1. Logo -->
      <div class="flex-1 flex justify-start">
        <a href={`/${lang}/`} class="group transition-opacity hover:opacity-80">
          <img
            src="/logo.webp"
            alt="Logo"
            class="h-10 w-auto object-contain brightness-0 invert opacity-90 group-hover:opacity-100 transition-all"
          />
        </a>
      </div>

      <!-- 2. Desktop Navigation -->
      <div class="hidden md:flex flex-1 justify-center space-x-10 items-center">
        {
          navLinks.map((link) => {
            const active = isActive(link.href);
            return (
              <a
                href={link.href}
                class={`text-[11px] uppercase tracking-[0.2em] py-2 transition-colors 
                ${active ? "text-amber-200" : "text-white/80 hover:text-amber-200"}`}
              >
                {link.name}
              </a>
            );
          })
        }
      </div>

      <!-- 3. Desktop Language -->
      <div class="hidden md:flex flex-1 justify-end items-center">
        <div class="relative inline-block text-left" id="lang-dropdown-wrapper">
          <button
            type="button"
            id="lang-button"
            class="group flex items-center gap-3 px-3 py-2 text-[10px] font-medium tracking-widest text-white/60 hover:text-white transition-colors uppercase border border-transparent rounded-sm hover:border-white/10"
          >
            <span
              class="text-base grayscale group-hover:grayscale-0 transition-all"
            >
              {currentLangObj.flag}
            </span>
            <span>{currentLangObj.code}</span>
            <svg
              class="w-3 h-3 opacity-50 group-hover:opacity-100 transition-opacity"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1"
                d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>

          <div
            id="lang-menu"
            class="hidden absolute right-0 mt-2 w-48 origin-top-right bg-[#0f0f0f] border border-white/10 shadow-2xl z-50 animate-fade-in-up"
          >
            <div class="py-2">
              <span
                class="block px-4 py-2 text-[9px] uppercase tracking-[0.3em] text-white/30 border-b border-white/5 mb-1"
              >
                Seleccionar Idioma
              </span>
              {
                languages.map((l) => (
                  <a
                    href={getPathForLang(l.code)}
                    class={`flex items-center gap-4 px-4 py-3 text-xs tracking-wider transition-colors hover:bg-white/5
                    ${lang === l.code ? "text-amber-200" : "text-gray-400 hover:text-white"}`}
                  >
                    <span class="text-lg">{l.flag}</span>
                    <span class="uppercase">{l.label}</span>
                  </a>
                ))
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Mobile Menu Button -->
      <div class="md:hidden flex items-center">
        <button
          id="menu-toggle"
          type="button"
          class="p-2 text-white/80 hover:text-amber-200 transition-colors focus:outline-none"
          aria-label="Menu"
        >
          <svg
            id="menu-icon"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1"
              d="M4 8h16M4 16h16"></path>
          </svg>
          <svg
            id="close-icon"
            class="h-6 w-6 hidden"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Menu Overlay -->
    <div
      id="mobile-menu"
      class="hidden md:hidden fixed inset-0 top-20 bg-[#0a0a0a] z-40 overflow-y-auto animate-fade-in"
    >
      <div
        class="flex flex-col items-center justify-center min-h-[60vh] space-y-8 p-6"
      >
        <nav class="flex flex-col items-center space-y-6 w-full">
          {
            navLinks.map((link) => {
              const active = isActive(link.href);
              return (
                <a
                  href={link.href}
                  class={`text-2xl font-serif italic transition-colors 
                  ${active ? "text-amber-200" : "text-white/80 hover:text-amber-200"}`}
                >
                  {link.name}
                </a>
              );
            })
          }
        </nav>

        <div class="w-12 h-px bg-white/10"></div>

        <div class="grid grid-cols-3 gap-6">
          {
            languages.map((l) => (
              <a
                href={getPathForLang(l.code)}
                class={`flex flex-col items-center gap-2 p-2 rounded-md transition-all
                ${lang === l.code ? "text-amber-200 scale-110" : "text-gray-500 hover:text-white"}`}
              >
                <span class="text-2xl">{l.flag}</span>
                <span class="text-[10px] uppercase tracking-widest">
                  {l.code}
                </span>
              </a>
            ))
          }
        </div>
      </div>
    </div>
  </nav>
</header>

<!-- JS Script bleibt gleich wie oben, hier zur Vollständigkeit -->
<script>
  const menuToggle = document.getElementById("menu-toggle");
  const mobileMenu = document.getElementById("mobile-menu");
  const menuIcon = document.getElementById("menu-icon");
  const closeIcon = document.getElementById("close-icon");
  const header = document.getElementById("main-header");
  const langButton = document.getElementById("lang-button");
  const langMenu = document.getElementById("lang-menu");

  function toggleMobileMenu() {
    const isHidden = mobileMenu?.classList.contains("hidden");
    if (isHidden) {
      mobileMenu?.classList.remove("hidden");
      menuIcon?.classList.add("hidden");
      closeIcon?.classList.remove("hidden");
      header?.classList.remove("bg-[#0a0a0a]/80", "backdrop-blur-md");
      header?.classList.add("bg-[#0a0a0a]");
    } else {
      mobileMenu?.classList.add("hidden");
      menuIcon?.classList.remove("hidden");
      closeIcon?.classList.add("hidden");
      header?.classList.add("bg-[#0a0a0a]/80", "backdrop-blur-md");
      header?.classList.remove("bg-[#0a0a0a]");
    }
  }

  menuToggle?.addEventListener("click", (e) => {
    e.stopPropagation();
    toggleMobileMenu();
  });
  langButton?.addEventListener("click", (e) => {
    e.stopPropagation();
    langMenu?.classList.toggle("hidden");
  });

  document.addEventListener("click", (event) => {
    const target = event.target as Node;
    if (!langButton?.contains(target) && !langMenu?.contains(target))
      langMenu?.classList.add("hidden");
    if (
      !mobileMenu?.classList.contains("hidden") &&
      !menuToggle?.contains(target) &&
      !mobileMenu?.contains(target)
    )
      toggleMobileMenu();
  });
</script>

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(5px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .animate-fade-in {
    animation: fadeIn 0.3s ease-out forwards;
  }
  .animate-fade-in-up {
    animation: fadeInUp 0.2s ease-out forwards;
  }
</style>
