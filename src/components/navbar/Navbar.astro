---
import { getCollection } from "astro:content";

const languages = ((await getCollection("languages")) ?? []).map(
  (it) => it.data
);
const { lang = languages[0] ? languages[0].code : "" } = Astro.params;

const translations = {
  es: { home: "Inicio", menu: "Menú", contact: "Contacto" },
  en: { home: "Home", menu: "Menu", contact: "Contact" },
  de: { home: "Start", menu: "Menü", contact: "Kontakt" },
};

const t = translations[lang as keyof typeof translations] || translations.es;

const navLinks = [
  { name: t.home, href: `/${lang}/` },
  { name: t.menu, href: `/${lang}/menu` },
  { name: t.contact, href: `/${lang}/contact` },
];

const currentLangObj = languages.find((l) => l.code === lang) || languages[0];
const currentPath = Astro.url.pathname;

const isActive = (href: string) => {
  const normalize = (path: string) => path.replace(/\/$/, "");
  return normalize(currentPath) === normalize(href);
};

const getPathForLang = (newLang: string) => {
  const parts = currentPath.split("/").filter(Boolean);
  if (parts.length > 0 && languages.some((l) => l.code === parts[0])) {
    parts[0] = newLang;
    return "/" + parts.join("/");
  }
  return `/${newLang}/`;
};
---

<header
  id="main-header"
  class="fixed top-0 left-0 w-full z-50 transition-colors duration-200 border-b border-white/5 bg-background/80 backdrop-blur-md"
>
  <nav class="max-w-7xl mx-auto px-6" aria-label="Top">
    <div class="flex justify-between items-center h-16">
      <!-- 1. Logo -->
      <div class="flex-1 flex justify-start">
        <a href={`/${lang}/`} class="group transition-opacity hover:opacity-80">
          <img
            src="/logo.webp"
            alt="Logo"
            class="h-10 w-auto object-contain brightness-0 invert opacity-90 group-hover:opacity-100 transition-all"
          />
        </a>
      </div>

      <!-- 2. Desktop Navigation -->
      <div class="hidden md:flex flex-1 justify-center space-x-12 items-center">
        {
          navLinks.map((link) => {
            const active = isActive(link.href);
            return (
              <a
                href={link.href}
                class={`text-[11px] uppercase tracking-[0.2em] py-2 transition-colors duration-300
                ${active ? "text-amber-200" : "text-white/70 hover:text-amber-200"}`}
              >
                {link.name}
              </a>
            );
          })
        }
      </div>

      <!-- 3. Desktop Language Picker -->
      <div class="hidden md:flex flex-1 justify-end items-center">
        <div class="relative inline-block text-left" id="lang-dropdown-wrapper">
          <button
            type="button"
            id="lang-button"
            class="group flex items-center gap-3 focus:outline-none py-2"
          >
            <!-- Flagge (Farbig & Schatten) -->
            <span
              class="text-2xl drop-shadow-sm group-hover:scale-110 transition-transform duration-300"
            >
              {currentLangObj.flag}
            </span>
            <span
              class="h-4 w-px bg-white/10 group-hover:bg-amber-200/50 transition-colors"
            ></span>
            <svg
              class="w-3 h-3 text-white/40 group-hover:text-amber-200 transition-colors"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1"
                d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>

          <!-- Desktop Dropdown -->
          <div
            id="lang-menu"
            class="hidden absolute right-0 mt-4 w-48 origin-top-right bg-[#050505]/95 backdrop-blur-xl border border-amber-200/10 shadow-2xl z-50 rounded-sm"
          >
            <div class="py-1">
              {
                languages.map((l) => (
                  <a
                    href={getPathForLang(l.code)}
                    class="group flex items-center gap-4 px-5 py-3 hover:bg-white/5 transition-colors border-b border-white/5 last:border-0"
                  >
                    <span class="text-lg drop-shadow-sm group-hover:scale-110 transition-transform duration-300">
                      {l.flag}
                    </span>
                    <div class="flex-1 flex justify-between items-center">
                      <span
                        class={`font-serif italic text-lg ${lang === l.code ? "text-amber-200" : "text-gray-400 group-hover:text-white"}`}
                      >
                        {l.name}
                      </span>
                      {lang === l.code && (
                        <span class="w-1 h-1 rounded-full bg-amber-200 shadow-[0_0_8px_rgba(253,230,138,0.5)]" />
                      )}
                    </div>
                  </a>
                ))
              }
            </div>
          </div>
        </div>
      </div>

      <!-- 4. Mobile Controls -->
      <div class="md:hidden flex items-center gap-5">
        <!-- Mobile Flagge (Öffnet Menü) -->
        <button
          id="mobile-lang-trigger"
          type="button"
          class="flex items-center justify-center active:scale-95 transition-transform"
          aria-label="Change Language"
        >
          <span class="text-2xl drop-shadow-md">{currentLangObj.flag}</span>
        </button>

        <!-- Burger Icon -->
        <button
          id="menu-toggle"
          type="button"
          class="p-1 text-white/80 hover:text-amber-200 transition-colors focus:outline-none"
          aria-label="Menu"
        >
          <svg
            id="menu-icon"
            class="h-7 w-7"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1"
              d="M4 8h16M4 16h16"></path>
          </svg>
          <svg
            id="close-icon"
            class="h-7 w-7 hidden"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Menu Overlay (Keine Animation, nur hidden Toggle) -->
    <div
      id="mobile-menu"
      class="hidden md:hidden fixed inset-0 top-20 bg-background z-40 overflow-y-auto"
    >
      <div
        class="flex flex-col items-center justify-center min-h-[60vh] space-y-8 p-6"
      >
        <nav class="flex flex-col items-center space-y-6 w-full">
          {
            navLinks.map((link) => {
              const active = isActive(link.href);
              return (
                <a
                  href={link.href}
                  class={`text-2xl font-serif italic transition-colors 
                  ${active ? "text-amber-200" : "text-white/80 hover:text-amber-200"}`}
                >
                  {link.name}
                </a>
              );
            })
          }
        </nav>

        <div class="w-12 h-px bg-white/10"></div>

        <div class="grid grid-cols-3 gap-6">
          {
            languages.map((l) => (
              <a
                href={getPathForLang(l.code)}
                class={`flex flex-col items-center gap-2 p-3 rounded-md transition-all border border-transparent
                ${lang === l.code ? "border-amber-200/20 bg-white/5" : "text-gray-500"}`}
              >
                <span class="text-3xl drop-shadow-md">{l.flag}</span>
                <span
                  class={`text-[10px] uppercase tracking-widest ${lang === l.code ? "text-amber-200" : "text-white/50"}`}
                >
                  {l.code}
                </span>
              </a>
            ))
          }
        </div>
      </div>
    </div>
  </nav>
</header>

<script>
  const menuToggle = document.getElementById("menu-toggle");
  const mobileLangTrigger = document.getElementById("mobile-lang-trigger");
  const mobileMenu = document.getElementById("mobile-menu");
  const menuIcon = document.getElementById("menu-icon");
  const closeIcon = document.getElementById("close-icon");
  const header = document.getElementById("main-header");
  const langButton = document.getElementById("lang-button");
  const langMenu = document.getElementById("lang-menu");

  function toggleMobileMenu() {
    const isHidden = mobileMenu?.classList.contains("hidden");

    if (isHidden) {
      // Öffnen: Sofort sichtbar machen
      mobileMenu?.classList.remove("hidden");
      menuIcon?.classList.add("hidden");
      closeIcon?.classList.remove("hidden");
      // Header Hintergrund solide machen
      header?.classList.remove("backdrop-blur-md", "bg-[#0a0a0a]/80");
      header?.classList.add("bg-[#0a0a0a]");
    } else {
      // Schließen: Sofort ausblenden
      mobileMenu?.classList.add("hidden");
      menuIcon?.classList.remove("hidden");
      closeIcon?.classList.add("hidden");
      // Blur zurücksetzen
      header?.classList.add("backdrop-blur-md", "bg-[#0a0a0a]/80");
      header?.classList.remove("bg-[#0a0a0a]");
    }
  }

  // Event Listener
  menuToggle?.addEventListener("click", (e) => {
    e.stopPropagation();
    toggleMobileMenu();
  });
  mobileLangTrigger?.addEventListener("click", (e) => {
    e.stopPropagation();
    toggleMobileMenu();
  });
  langButton?.addEventListener("click", (e) => {
    e.stopPropagation();
    langMenu?.classList.toggle("hidden");
  });

  document.addEventListener("click", (event) => {
    const target = event.target as Node;
    if (!langButton?.contains(target) && !langMenu?.contains(target))
      langMenu?.classList.add("hidden");
    if (
      !mobileMenu?.classList.contains("hidden") &&
      !menuToggle?.contains(target) &&
      !mobileLangTrigger?.contains(target) &&
      !mobileMenu?.contains(target)
    ) {
      toggleMobileMenu();
    }
  });
</script>
