---
import '../styles/global.css';
---

<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>XML Compare Tool</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  </head>
  <body class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
      <!-- Header -->
      <header class="text-center mb-8">
        <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent mb-2">
          XML Compare
        </h1>
        <p class="text-slate-400 text-lg">Vergleiche XML-Dokumente strukturell und inhaltlich</p>
      </header>

      <!-- Hidden file inputs -->
      <input type="file" id="file-input-left" class="hidden" accept=".xml,.xsd,.xslt,.svg,.html,.xhtml" />
      <input type="file" id="file-input-right" class="hidden" accept=".xml,.xsd,.xslt,.svg,.html,.xhtml" />

      <!-- Toolbar -->
      <div class="flex items-center justify-end mb-4">
        <label class="flex items-center gap-2 cursor-pointer select-none">
          <span class="text-sm text-slate-400">Sync Scroll</span>
          <div class="relative">
            <input type="checkbox" id="sync-scroll-toggle" class="sr-only peer" checked />
            <div class="w-10 h-5 bg-slate-700 rounded-full peer peer-checked:bg-blue-600 transition-colors"></div>
            <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-slate-300 rounded-full peer-checked:translate-x-5 transition-transform"></div>
          </div>
        </label>
      </div>

      <!-- Editor Section -->
      <div class="grid lg:grid-cols-2 gap-4 mb-6">
        <!-- Left Editor -->
        <div class="flex flex-col">
          <div class="flex items-center justify-between px-3 py-2 bg-slate-800 border border-slate-700 border-b-0 rounded-t-xl">
            <div class="flex items-center gap-2">
              <span class="w-3 h-3 rounded-full bg-blue-500"></span>
              <span id="filename-left" class="text-sm font-medium text-slate-300">Dokument A</span>
            </div>
            <button
              id="load-file-left"
              class="px-3 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded-md text-slate-300 transition-colors flex items-center gap-1.5"
            >
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
              </svg>
              Datei laden
            </button>
          </div>
          <div id="editor-left" class="h-96 border border-slate-700 rounded-b-xl overflow-hidden"></div>
        </div>

        <!-- Right Editor -->
        <div class="flex flex-col">
          <div class="flex items-center justify-between px-3 py-2 bg-slate-800 border border-slate-700 border-b-0 rounded-t-xl">
            <div class="flex items-center gap-2">
              <span class="w-3 h-3 rounded-full bg-cyan-500"></span>
              <span id="filename-right" class="text-sm font-medium text-slate-300">Dokument B</span>
            </div>
            <button
              id="load-file-right"
              class="px-3 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded-md text-slate-300 transition-colors flex items-center gap-1.5"
            >
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
              </svg>
              Datei laden
            </button>
          </div>
          <div id="editor-right" class="h-96 border border-slate-700 rounded-b-xl overflow-hidden"></div>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex justify-center gap-4 mb-8">
        <button
          id="compare-btn"
          class="px-8 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 rounded-xl font-semibold text-white shadow-lg shadow-blue-500/25 hover:shadow-blue-500/40 transition-all duration-200 flex items-center gap-2"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
          Vergleichen
        </button>
        <button
          id="clear-btn"
          class="px-6 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-medium text-slate-300 transition-all duration-200"
        >
          Zurücksetzen
        </button>
      </div>

      <!-- Error Display -->
      <div id="error-container" class="hidden mb-6">
        <div class="bg-red-500/10 border border-red-500/30 rounded-xl p-4">
          <p id="error-message" class="text-red-400 text-sm font-medium"></p>
        </div>
      </div>

      <!-- Results Section -->
      <div id="results-container" class="hidden">
        <!-- Stats -->
        <div id="stats" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
          <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 text-center">
            <p class="text-3xl font-bold text-green-400" id="stat-equal">0</p>
            <p class="text-xs text-slate-400 mt-1">Identisch</p>
          </div>
          <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 text-center">
            <p class="text-3xl font-bold text-amber-400" id="stat-different">0</p>
            <p class="text-xs text-slate-400 mt-1">Unterschiedlich</p>
          </div>
          <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 text-center">
            <p class="text-3xl font-bold text-blue-400" id="stat-missing-left">0</p>
            <p class="text-xs text-slate-400 mt-1">Nur in B</p>
          </div>
          <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 text-center">
            <p class="text-3xl font-bold text-cyan-400" id="stat-missing-right">0</p>
            <p class="text-xs text-slate-400 mt-1">Nur in A</p>
          </div>
        </div>

        <!-- Success Message -->
        <div id="success-message" class="hidden mb-6">
          <div class="bg-green-500/10 border border-green-500/30 rounded-xl p-6 text-center">
            <svg class="w-16 h-16 mx-auto text-green-500 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-green-400 text-lg font-semibold">Die XML-Dokumente sind identisch!</p>
          </div>
        </div>

        <!-- Differences Table -->
        <div id="differences-container" class="hidden">
          <div class="bg-slate-800/50 border border-slate-700 rounded-xl overflow-hidden">
            <div class="px-4 py-3 border-b border-slate-700 bg-slate-800/50 flex items-center justify-between">
              <h2 class="font-semibold text-slate-200">Gefundene Unterschiede</h2>
              <span class="text-xs text-slate-500">Klicke auf eine Zeile um zur Stelle zu springen</span>
            </div>
            <div class="overflow-x-auto max-h-96">
              <table class="w-full text-sm">
                <thead class="sticky top-0 bg-slate-800">
                  <tr class="border-b border-slate-700 text-left">
                    <th class="px-4 py-3 text-slate-400 font-medium">Status</th>
                    <th class="px-4 py-3 text-slate-400 font-medium">Pfad</th>
                    <th class="px-4 py-3 text-slate-400 font-medium text-center w-16">Zeile A</th>
                    <th class="px-4 py-3 text-slate-400 font-medium text-center w-16">Zeile B</th>
                    <th class="px-4 py-3 text-slate-400 font-medium">Wert A</th>
                    <th class="px-4 py-3 text-slate-400 font-medium">Wert B</th>
                  </tr>
                </thead>
                <tbody id="differences-tbody" class="divide-y divide-slate-700/50">
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <footer class="mt-16 text-center text-slate-500 text-sm">
        <p>XML Compare Tool &bull; Alle Daten werden lokal im Browser verarbeitet</p>
      </footer>
    </div>

    <script>
      import * as monaco from 'monaco-editor';
      import { parseXml, compareXml, getStats, findLineInXml, type CompareResult } from '../lib/xml-compare';

      // Configure Monaco workers
      self.MonacoEnvironment = {
        getWorker: function (_moduleId: string, label: string) {
          const getWorkerModule = (moduleUrl: string, label: string) => {
            return new Worker(new URL(`monaco-editor/esm/vs/editor/editor.worker.js`, import.meta.url), {
              type: 'module'
            });
          };
          return getWorkerModule('', label);
        }
      };

      // Editor theme
      monaco.editor.defineTheme('xmlDark', {
        base: 'vs-dark',
        inherit: true,
        rules: [
          { token: 'tag', foreground: '60a5fa' },
          { token: 'attribute.name', foreground: '22d3ee' },
          { token: 'attribute.value', foreground: 'fbbf24' },
          { token: 'comment', foreground: '6b7280' },
          { token: 'string', foreground: 'a5f3fc' },
        ],
        colors: {
          'editor.background': '#1e293b',
          'editor.foreground': '#e2e8f0',
          'editorLineNumber.foreground': '#64748b',
          'editorLineNumber.activeForeground': '#94a3b8',
          'editor.lineHighlightBackground': '#334155',
          'editor.selectionBackground': '#3b82f680',
          'editorCursor.foreground': '#3b82f6',
        }
      });

      const editorOptions: monaco.editor.IStandaloneEditorConstructionOptions = {
        language: 'xml',
        theme: 'xmlDark',
        minimap: { enabled: false },
        fontSize: 13,
        fontFamily: 'ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace',
        lineNumbers: 'on',
        scrollBeyondLastLine: false,
        automaticLayout: true,
        wordWrap: 'on',
        padding: { top: 12, bottom: 12 },
        renderLineHighlight: 'line',
        scrollbar: {
          verticalScrollbarSize: 8,
          horizontalScrollbarSize: 8,
        },
      };

      // Create editors
      const editorLeft = monaco.editor.create(
        document.getElementById('editor-left')!,
        { ...editorOptions, value: '' }
      );

      const editorRight = monaco.editor.create(
        document.getElementById('editor-right')!,
        { ...editorOptions, value: '' }
      );

      // DOM Elements
      const compareBtn = document.getElementById('compare-btn') as HTMLButtonElement;
      const clearBtn = document.getElementById('clear-btn') as HTMLButtonElement;
      const errorContainer = document.getElementById('error-container') as HTMLDivElement;
      const errorMessage = document.getElementById('error-message') as HTMLParagraphElement;
      const resultsContainer = document.getElementById('results-container') as HTMLDivElement;
      const successMessage = document.getElementById('success-message') as HTMLDivElement;
      const differencesContainer = document.getElementById('differences-container') as HTMLDivElement;
      const differencesTbody = document.getElementById('differences-tbody') as HTMLTableSectionElement;
      const syncScrollToggle = document.getElementById('sync-scroll-toggle') as HTMLInputElement;

      // File loading elements
      const fileInputLeft = document.getElementById('file-input-left') as HTMLInputElement;
      const fileInputRight = document.getElementById('file-input-right') as HTMLInputElement;
      const loadFileLeftBtn = document.getElementById('load-file-left') as HTMLButtonElement;
      const loadFileRightBtn = document.getElementById('load-file-right') as HTMLButtonElement;
      const filenameLeft = document.getElementById('filename-left') as HTMLSpanElement;
      const filenameRight = document.getElementById('filename-right') as HTMLSpanElement;

      // Sample data
      const sampleXmlA = `<?xml version="1.0" encoding="UTF-8"?>
<bookstore>
  <book category="fiction">
    <title lang="de">Der Prozess</title>
    <author>Franz Kafka</author>
    <year>1925</year>
    <price>12.99</price>
  </book>
  <book category="science">
    <title lang="en">A Brief History of Time</title>
    <author>Stephen Hawking</author>
    <year>1988</year>
    <price>15.99</price>
  </book>
</bookstore>`;

      const sampleXmlB = `<?xml version="1.0" encoding="UTF-8"?>
<bookstore>
  <book category="fiction">
    <title lang="de">Der Prozess</title>
    <author>Franz Kafka</author>
    <year>1926</year>
    <price>14.99</price>
  </book>
  <book category="non-fiction">
    <title lang="en">A Brief History of Time</title>
    <author>Stephen Hawking</author>
    <year>1988</year>
    <price>15.99</price>
    <isbn>978-0553380163</isbn>
  </book>
</bookstore>`;

      // Sync scroll
      let isSyncing = false;

      function syncScroll(source: monaco.editor.IStandaloneCodeEditor, target: monaco.editor.IStandaloneCodeEditor) {
        if (!syncScrollToggle.checked || isSyncing) return;
        isSyncing = true;

        const sourceScrollTop = source.getScrollTop();
        target.setScrollTop(sourceScrollTop);

        requestAnimationFrame(() => {
          isSyncing = false;
        });
      }

      editorLeft.onDidScrollChange(() => syncScroll(editorLeft, editorRight));
      editorRight.onDidScrollChange(() => syncScroll(editorRight, editorLeft));

      // File loading
      function loadFile(input: HTMLInputElement, editor: monaco.editor.IStandaloneCodeEditor, filenameEl: HTMLSpanElement) {
        const file = input.files?.[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          const content = e.target?.result as string;
          editor.setValue(content);
          filenameEl.textContent = file.name;
          filenameEl.title = file.name;
        };
        reader.onerror = () => {
          showError(`Fehler beim Laden der Datei: ${file.name}`);
        };
        reader.readAsText(file);
      }

      loadFileLeftBtn.addEventListener('click', () => fileInputLeft.click());
      loadFileRightBtn.addEventListener('click', () => fileInputRight.click());

      fileInputLeft.addEventListener('change', () => loadFile(fileInputLeft, editorLeft, filenameLeft));
      fileInputRight.addEventListener('change', () => loadFile(fileInputRight, editorRight, filenameRight));

      // Drag and drop support
      function setupDropZone(container: HTMLElement, editor: monaco.editor.IStandaloneCodeEditor, filenameEl: HTMLSpanElement) {
        container.addEventListener('dragover', (e) => {
          e.preventDefault();
          container.classList.add('ring-2', 'ring-blue-500');
        });

        container.addEventListener('dragleave', () => {
          container.classList.remove('ring-2', 'ring-blue-500');
        });

        container.addEventListener('drop', (e) => {
          e.preventDefault();
          container.classList.remove('ring-2', 'ring-blue-500');

          const file = e.dataTransfer?.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (ev) => {
            const content = ev.target?.result as string;
            editor.setValue(content);
            filenameEl.textContent = file.name;
            filenameEl.title = file.name;
          };
          reader.readAsText(file);
        });
      }

      setupDropZone(document.getElementById('editor-left')!, editorLeft, filenameLeft);
      setupDropZone(document.getElementById('editor-right')!, editorRight, filenameRight);

      // Clear button
      clearBtn.addEventListener('click', () => {
        editorLeft.setValue('');
        editorRight.setValue('');
        filenameLeft.textContent = 'Dokument A';
        filenameRight.textContent = 'Dokument B';
        hideResults();
        hideError();
        // Clear decorations
        editorLeft.deltaDecorations(editorLeft.getModel()?.getAllDecorations().map(d => d.id) || [], []);
        editorRight.deltaDecorations(editorRight.getModel()?.getAllDecorations().map(d => d.id) || [], []);
        // Reset file inputs
        fileInputLeft.value = '';
        fileInputRight.value = '';
      });

      compareBtn.addEventListener('click', () => {
        hideError();
        hideResults();

        const leftValue = editorLeft.getValue().trim();
        const rightValue = editorRight.getValue().trim();

        if (!leftValue || !rightValue) {
          showError('Bitte beide XML-Dokumente eingeben.');
          return;
        }

        try {
          const leftParsed = parseXml(leftValue);
          const rightParsed = parseXml(rightValue);
          const results = compareXml(leftParsed, rightParsed);

          displayResults(results);
          highlightDifferences(results);
        } catch (e) {
          showError(`XML Parse-Fehler: ${(e as Error).message}`);
        }
      });

      function showError(message: string) {
        errorMessage.textContent = message;
        errorContainer.classList.remove('hidden');
      }

      function hideError() {
        errorContainer.classList.add('hidden');
      }

      function hideResults() {
        resultsContainer.classList.add('hidden');
        successMessage.classList.add('hidden');
        differencesContainer.classList.add('hidden');
      }

      // Store decoration IDs for cleanup
      let leftDecorations: string[] = [];
      let rightDecorations: string[] = [];

      function highlightDifferences(results: CompareResult[]) {
        const leftDecos: monaco.editor.IModelDeltaDecoration[] = [];
        const rightDecos: monaco.editor.IModelDeltaDecoration[] = [];

        const leftText = editorLeft.getValue();
        const rightText = editorRight.getValue();

        for (const result of results) {
          const leftLine = findLineInXml(leftText, result.path, result.leftValue) + 1;
          const rightLine = findLineInXml(rightText, result.path, result.rightValue) + 1;

          const getClassName = (status: string) => {
            switch (status) {
              case 'different': return 'line-highlight-different';
              case 'missing-left': return 'line-highlight-missing';
              case 'missing-right': return 'line-highlight-missing';
              default: return 'line-highlight-different';
            }
          };

          if (result.status !== 'missing-left' && leftLine > 0) {
            leftDecos.push({
              range: new monaco.Range(leftLine, 1, leftLine, 1),
              options: {
                isWholeLine: true,
                className: getClassName(result.status),
                glyphMarginClassName: 'glyph-margin-diff',
              }
            });
          }

          if (result.status !== 'missing-right' && rightLine > 0) {
            rightDecos.push({
              range: new monaco.Range(rightLine, 1, rightLine, 1),
              options: {
                isWholeLine: true,
                className: getClassName(result.status),
                glyphMarginClassName: 'glyph-margin-diff',
              }
            });
          }
        }

        leftDecorations = editorLeft.deltaDecorations(leftDecorations, leftDecos);
        rightDecorations = editorRight.deltaDecorations(rightDecorations, rightDecos);
      }

      function displayResults(results: CompareResult[]) {
        const stats = getStats(results);
        resultsContainer.classList.remove('hidden');

        (document.getElementById('stat-equal') as HTMLParagraphElement).textContent =
          results.length === 0 ? '✓' : '0';
        (document.getElementById('stat-different') as HTMLParagraphElement).textContent =
          stats.different.toString();
        (document.getElementById('stat-missing-left') as HTMLParagraphElement).textContent =
          stats.missingLeft.toString();
        (document.getElementById('stat-missing-right') as HTMLParagraphElement).textContent =
          stats.missingRight.toString();

        if (results.length === 0) {
          successMessage.classList.remove('hidden');
          differencesContainer.classList.add('hidden');
        } else {
          successMessage.classList.add('hidden');
          differencesContainer.classList.remove('hidden');
          renderDifferences(results);
        }
      }

      function renderDifferences(results: CompareResult[]) {
        differencesTbody.innerHTML = '';

        const leftText = editorLeft.getValue();
        const rightText = editorRight.getValue();

        for (const result of results) {
          const row = document.createElement('tr');
          row.className = 'hover:bg-slate-700/30 transition-colors cursor-pointer';

          const leftLine = findLineInXml(leftText, result.path, result.leftValue);
          const rightLine = findLineInXml(rightText, result.path, result.rightValue);

          row.addEventListener('click', () => {
            // Temporarily disable sync scroll
            const wasSyncEnabled = syncScrollToggle.checked;
            syncScrollToggle.checked = false;

            // Reveal lines in editors
            if (result.status !== 'missing-left') {
              editorLeft.revealLineInCenter(leftLine + 1);
              editorLeft.setPosition({ lineNumber: leftLine + 1, column: 1 });
            }

            setTimeout(() => {
              if (result.status !== 'missing-right') {
                editorRight.revealLineInCenter(rightLine + 1);
                editorRight.setPosition({ lineNumber: rightLine + 1, column: 1 });
              }

              setTimeout(() => {
                syncScrollToggle.checked = wasSyncEnabled;
              }, 100);
            }, 50);
          });

          const statusCell = document.createElement('td');
          statusCell.className = 'px-4 py-3';
          statusCell.innerHTML = getStatusBadge(result.status);

          const pathCell = document.createElement('td');
          pathCell.className = 'px-4 py-3 font-mono text-xs text-slate-300';
          pathCell.textContent = result.path;

          const leftLineCell = document.createElement('td');
          leftLineCell.className = 'px-4 py-3 font-mono text-xs text-center';
          if (result.status === 'missing-left') {
            leftLineCell.innerHTML = '<span class="text-slate-500">—</span>';
          } else {
            leftLineCell.innerHTML = `<span class="text-blue-400 font-medium">${leftLine + 1}</span>`;
          }

          const rightLineCell = document.createElement('td');
          rightLineCell.className = 'px-4 py-3 font-mono text-xs text-center';
          if (result.status === 'missing-right') {
            rightLineCell.innerHTML = '<span class="text-slate-500">—</span>';
          } else {
            rightLineCell.innerHTML = `<span class="text-cyan-400 font-medium">${rightLine + 1}</span>`;
          }

          const leftValueCell = document.createElement('td');
          leftValueCell.className = 'px-4 py-3 font-mono text-xs';
          leftValueCell.innerHTML = formatValue(result.leftValue, result.status === 'missing-left');

          const rightValueCell = document.createElement('td');
          rightValueCell.className = 'px-4 py-3 font-mono text-xs';
          rightValueCell.innerHTML = formatValue(result.rightValue, result.status === 'missing-right');

          row.appendChild(statusCell);
          row.appendChild(pathCell);
          row.appendChild(leftLineCell);
          row.appendChild(rightLineCell);
          row.appendChild(leftValueCell);
          row.appendChild(rightValueCell);

          differencesTbody.appendChild(row);
        }
      }

      function getStatusBadge(status: CompareResult['status']): string {
        const badges: Record<string, string> = {
          'different': '<span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-amber-500/20 text-amber-400">Unterschied</span>',
          'missing-left': '<span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-blue-500/20 text-blue-400">Nur in B</span>',
          'missing-right': '<span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-cyan-500/20 text-cyan-400">Nur in A</span>',
          'type-mismatch': '<span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-red-500/20 text-red-400">Typ-Konflikt</span>',
        };
        return badges[status] || status;
      }

      function formatValue(value: string | null | undefined, isMissing: boolean): string {
        if (isMissing) {
          return '<span class="text-slate-500 italic">—</span>';
        }
        if (value === null || value === undefined) {
          return '<span class="text-slate-500 italic">leer</span>';
        }
        const escaped = value.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return `<span class="text-slate-200">${escaped}</span>`;
      }
    </script>

    <style is:global>
      .line-highlight-different {
        background-color: rgba(251, 191, 36, 0.15) !important;
        border-left: 3px solid #fbbf24 !important;
      }
      .line-highlight-missing {
        background-color: rgba(96, 165, 250, 0.15) !important;
        border-left: 3px solid #60a5fa !important;
      }
      .glyph-margin-diff {
        background-color: #fbbf24;
        width: 4px !important;
        margin-left: 3px;
        border-radius: 2px;
      }
    </style>
  </body>
</html>
