---
export const prerender = false;

import { readItems } from "@directus/sdk";
import Layout from "../layouts/Layout.astro";
import { getDirectusClient } from "../lib/directus";
import AgendaTable from "../components/AgendaTable.svelte";
import AgendaNavigation from "../components/AgendaNavigation.svelte";
import { format } from "date-fns";

const token = Astro.locals.token;

const dateParam = Astro.url.searchParams.get("date");
const date = dateParam || format(new Date(), "yyyy-MM-dd");

const directus = getDirectusClient(token);
const initialReservations = await directus.request(
  readItems("reservations", {
    fields: [
      "*",
      {
        user: ["*"],
      },
    ],
    filter: { date: { _eq: date } },
    sort: ["time"],
  })
);

const settings = await directus.request(
  readItems("reservations_settings", {
    limit: 1,
  })
);

const turns = settings[0]?.turns || [];
---

<Layout title="Agenda">
  <div class="container mx-auto mt-8">
    <AgendaNavigation client:load currentDateString={date} />
    <AgendaTable
      client:load
      token={token}
      initialData={initialReservations}
      turns={turns}
    />
  </div>
</Layout>
