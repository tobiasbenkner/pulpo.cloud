---
export const prerender = false;

import Layout from "../layouts/Layout.astro";
import ReservationForm from "../components/ReservationForm.svelte";
import { getDirectusClient } from "../lib/directus";
import { readItems, readUsers } from "@directus/sdk";
import { format } from "date-fns";

// 1. Auth & Token
const token = Astro.locals.token;
if (!token) return Astro.redirect("/login");

const dateParam =
  Astro.url.searchParams.get("date") || format(new Date(), "yyyy-MM-dd");

// 2. Daten laden (Settings für Turns & User Liste)
const client = getDirectusClient(token);

// Parallel Requests für Performance
const [settingsResponse, usersResponse] = await Promise.all([
  client.request(readItems("reservations_settings", { limit: 1 })),
  client.request(
    readUsers({
      filter: { status: { _eq: "active" } },
      fields: ["id", "first_name", "avatar", "tenant"],
      sort: ["first_name"],
    })
  ),
]);

const turns = settingsResponse[0]?.turns || [];
const users = usersResponse;
---

<Layout title="Neue Reservierung">
  <!-- Einfache Header Navigation -->
  <div
    class="navbar bg-[#1e2330] p-4 sticky top-0 z-20 border-b border-gray-700/50 mb-8"
  >
    <div class="flex-none">
      <a
        href={`/?date=${dateParam}`}
        class="btn btn-square btn-ghost text-white"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"></path></svg
        >
      </a>
    </div>
    <div class="flex-1">
      <a
        href={`/?date=${dateParam}`}
        class="btn btn-ghost normal-case text-xl text-white">Zurück</a
      >
    </div>
  </div>

  <main class="container mx-auto px-4 pb-12">
    <ReservationForm
      client:load
      token={token}
      dateParam={dateParam}
      turns={turns}
      users={users}
    />
  </main>
</Layout>
