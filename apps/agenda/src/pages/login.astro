---
import Layout from "../layouts/Layout.astro";
import { getDirectusClient } from "../lib/directus";

export const prerender = false;

// 1. Wenn der User schon eingeloggt ist -> Redirect zum Dashboard
if (Astro.cookies.has("directus_session")) {
  return Astro.redirect("/");
}

let error = "";

// 2. Formular-Verarbeitung (POST Request)
if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    const email = data.get("email")?.toString();
    const password = data.get("password")?.toString();

    if (!email || !password) {
      throw new Error("Bitte E-Mail und Passwort eingeben.");
    }

    // Directus Login Versuch
    const client = getDirectusClient();
    const loginData = await client.login({ email, password });

    // WICHTIG: Token sicher im Cookie speichern (HttpOnly)
    // access_token hält per Default kurz, refresh_token lang.
    // Für dieses Tutorial speichern wir den access_token.
    // In Produktion: Refresh-Logik einbauen oder Token-Lifetime in Directus erhöhen.
    if (loginData.access_token) {
      Astro.cookies.set("directus_session", loginData.access_token, {
        path: "/",
        httpOnly: true, // JS kann nicht zugreifen
        secure: import.meta.env.PROD, // HTTPS in Produktion
        sameSite: "lax",
        maxAge: 60 * 60 * 24 * 7, // 7 Tage (in Sekunden)
      });

      return Astro.redirect("/");
    }
  } catch (e: any) {
    console.error(e);
    // Fehlermeldung hübsch machen
    if (e.errors?.[0]?.message === "Invalid user credentials.") {
      error = "E-Mail oder Passwort falsch.";
    } else {
      error = e.message || "Ein unbekannter Fehler ist aufgetreten.";
    }
  }
}
---

<Layout title="Login">
  <div class="card w-full max-w-sm bg-base-100 shadow-xl">
    <div class="card-body">
      <h2 class="card-title text-2xl font-bold justify-center mb-4">
        Anmelden
      </h2>

      {
        error && (
          <div
            role="alert"
            class="alert alert-error text-sm py-2 rounded-md mb-2"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="stroke-current shrink-0 h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            <span>{error}</span>
          </div>
        )
      }

      <!-- Standard HTML Formular -> sendet POST an diese Seite -->
      <form method="POST" class="space-y-4">
        <div class="form-control">
          <label class="label">
            <span class="label-text">E-Mail</span>
          </label>
          <input
            type="email"
            name="email"
            placeholder="email@beispiel.de"
            class="input input-bordered"
            required
          />
        </div>

        <div class="form-control">
          <label class="label">
            <span class="label-text">Passwort</span>
          </label>
          <input
            type="password"
            name="password"
            placeholder="••••••••"
            class="input input-bordered"
            required
          />
          <label class="label">
            <a href="#" class="label-text-alt link link-hover"
              >Passwort vergessen?</a
            >
          </label>
        </div>

        <div class="form-control mt-6">
          <button class="btn btn-primary">Login</button>
        </div>
      </form>
    </div>
  </div>
</Layout>
