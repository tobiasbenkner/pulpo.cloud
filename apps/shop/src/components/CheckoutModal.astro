<script>
  import {
    isPaymentModalOpen,
    isCustomerModalOpen,
    cartTotals,
    completeTransaction,
    selectedCustomer,
    shouldPrintReceipt,
  } from "../stores/cartStore";

  // Elements
  const modal = document.getElementById("payment-modal")!;
  const backdrop = document.getElementById("modal-backdrop")!;
  const panel = document.getElementById("modal-panel")!;

  // Close Container
  const closeModalContainer = document.getElementById("close-modal-container")!;
  const closeBtnX = document.getElementById("close-modal-x")!;

  // Views
  const viewSelection = document.getElementById("view-selection")!;
  const viewCash = document.getElementById("view-cash")!;

  // Customer
  const customerSelector = document.getElementById("customer-selector")!;
  const noCustomerDiv = document.getElementById("no-customer")!;
  const hasCustomerDiv = document.getElementById("has-customer")!;
  const custDisplayName = document.getElementById("cust-display-name")!;

  // Displays
  const totalDisplays = document.querySelectorAll(".display-total");
  const inputDisplay = document.getElementById("cash-input-display")!;
  const changeDisplay = document.getElementById("change-display")!;

  // Buttons
  const btnCashStart = document.getElementById("btn-cash-start")!;
  const btnCardPay = document.getElementById("btn-card-pay")!;

  // --- FIX: Typisierung als HTMLButtonElement hinzufügen ---
  const btnConfirm = document.getElementById(
    "confirm-cash-btn"
  ) as HTMLButtonElement;

  const btnBack = document.getElementById("back-to-selection")!;
  const btnClear = document.getElementById("numpad-clear")!;
  const numpadBtns = document.querySelectorAll(".numpad-btn");
  const quickBtns = document.querySelectorAll(".quick-cash");

  // Toggle Groups
  const toggleContainers = document.querySelectorAll(".print-toggle-container");
  const toggleUIs = document.querySelectorAll(".toggle-print-ui");
  const toggleKnobs = document.querySelectorAll(".toggle-print-knob");

  let currentTotal = 0;
  let inputCents = 0;

  // --- VIEW LOGIC ---
  function showView(viewName: "selection" | "cash") {
    if (viewName === "selection") {
      viewSelection.classList.remove("hidden");
      viewCash.classList.add("hidden");
      closeModalContainer.classList.remove("hidden");
    } else {
      viewSelection.classList.add("hidden");
      viewCash.classList.remove("hidden");
      closeModalContainer.classList.add("hidden");
      updateNumpadDisplay();
    }
  }

  // --- VISIBILITY ---
  isPaymentModalOpen.subscribe((isOpen) => {
    if (isOpen) {
      modal.classList.remove("hidden");
      resetCashView();
      showView("selection");
      setTimeout(() => {
        backdrop.classList.remove("opacity-0");
        panel.classList.remove(
          "opacity-0",
          "translate-y-4",
          "sm:translate-y-0",
          "sm:scale-95"
        );
      }, 10);
    } else {
      backdrop.classList.add("opacity-0");
      panel.classList.add(
        "opacity-0",
        "translate-y-4",
        "sm:translate-y-0",
        "sm:scale-95"
      );
      setTimeout(() => modal.classList.add("hidden"), 300);
    }
  });

  closeBtnX.addEventListener("click", () => isPaymentModalOpen.set(false));

  // --- NAVIGATION ---
  btnCashStart.addEventListener("click", () => showView("cash"));
  btnBack.addEventListener("click", () => showView("selection"));

  // --- ACTIONS ---
  btnCardPay.addEventListener("click", () => {
    completeTransaction(
      currentTotal.toFixed(2),
      currentTotal.toFixed(2),
      "card"
    );
  });

  btnConfirm.addEventListener("click", () => {
    const tenderedStr = (inputCents / 100).toFixed(2);
    const totalStr = currentTotal.toFixed(2);
    completeTransaction(totalStr, tenderedStr, "cash");
  });

  // --- NUMPAD ---
  function resetCashView() {
    inputCents = 0;
    updateNumpadDisplay();
  }

  function updateNumpadDisplay() {
    const valInEuro = inputCents / 100;
    inputDisplay.textContent = valInEuro.toFixed(2) + " €";
    const change = valInEuro - currentTotal;

    if (change >= -0.005) {
      changeDisplay.textContent = change.toFixed(2) + " €";
      changeDisplay.classList.remove("text-red-400");
      changeDisplay.classList.add("text-emerald-400");
      btnConfirm.disabled = false;
      btnConfirm.innerHTML = `Rückgeld: ${change.toFixed(2)}€ • Fertig`;
      btnConfirm.classList.add("animate-pulse-slow");
    } else {
      changeDisplay.textContent = change.toFixed(2) + " €";
      changeDisplay.classList.remove("text-emerald-400");
      changeDisplay.classList.add("text-red-400");
      btnConfirm.disabled = true;
      btnConfirm.innerHTML = "Betrag zu gering";
      btnConfirm.classList.remove("animate-pulse-slow");
    }
  }

  numpadBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      const val = btn.getAttribute("data-val");
      if (inputCents.toString().length > 6) return;
      if (val === "00") inputCents = inputCents * 100;
      else inputCents = inputCents * 10 + parseInt(val!);
      updateNumpadDisplay();
    });
  });

  quickBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      inputCents = parseInt(btn.getAttribute("data-amount")!) * 100;
      updateNumpadDisplay();
    });
  });

  btnClear.addEventListener("click", () => {
    inputCents = 0;
    updateNumpadDisplay();
  });

  // --- CUSTOMER & TOTALS ---
  customerSelector.addEventListener("click", () =>
    isCustomerModalOpen.set(true)
  );

  selectedCustomer.subscribe((cust) => {
    if (cust) {
      noCustomerDiv.classList.add("hidden");
      hasCustomerDiv.classList.remove("hidden");
      hasCustomerDiv.classList.add("flex");
      custDisplayName.innerText = cust.name;
      customerSelector.classList.add("border-blue-200", "bg-blue-50");
      customerSelector.classList.remove("border-zinc-200", "bg-zinc-50");
    } else {
      noCustomerDiv.classList.remove("hidden");
      hasCustomerDiv.classList.add("hidden");
      hasCustomerDiv.classList.remove("flex");
      customerSelector.classList.remove("border-blue-200", "bg-blue-50");
      customerSelector.classList.add("border-zinc-200", "bg-zinc-50");
    }
  });

  cartTotals.subscribe((t) => {
    currentTotal = parseFloat(t.gross);
    totalDisplays.forEach((el) => (el.textContent = `${t.gross} €`));
  });

  // --- TOGGLE ---
  shouldPrintReceipt.subscribe((val) => {
    if (val) {
      toggleUIs.forEach((el) =>
        el.classList.replace("bg-zinc-200", "bg-blue-600")
      );
      toggleKnobs.forEach((el) =>
        el.classList.replace("translate-x-1", "translate-x-6")
      );
    } else {
      toggleUIs.forEach((el) =>
        el.classList.replace("bg-blue-600", "bg-zinc-200")
      );
      toggleKnobs.forEach((el) =>
        el.classList.replace("translate-x-6", "translate-x-1")
      );
    }
  });

  toggleContainers.forEach((container) => {
    container.addEventListener("click", () => {
      const current = shouldPrintReceipt.get();
      shouldPrintReceipt.set(!current);
    });
  });
</script>
