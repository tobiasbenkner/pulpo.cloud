---
// apps/shop/src/components/CheckoutModal.astro
---

<div
  id="payment-modal"
  class="fixed inset-0 z-50 hidden"
  role="dialog"
  aria-modal="true"
>
  <!-- Backdrop -->
  <div
    class="fixed inset-0 bg-zinc-900/40 backdrop-blur-md transition-opacity opacity-0"
    id="modal-backdrop"
  >
  </div>

  <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
    <div
      class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0"
    >
      <!-- Modal Panel -->
      <div
        class="relative transform overflow-hidden rounded-3xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        id="modal-panel"
      >
        <!-- Close Button Container -->
        <div class="absolute right-4 top-4 z-20" id="close-modal-container">
          <button
            id="close-modal-x"
            class="rounded-full p-2 bg-zinc-100 text-zinc-400 hover:text-zinc-600 transition-colors"
          >
            <svg
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="2"
              stroke="currentColor"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M6 18L18 6M6 6l12 12"></path></svg
            >
          </button>
        </div>

        <!-- ============================================ -->
        <!-- VIEW 1: AUSWAHL (BAR / KARTE)                -->
        <!-- ============================================ -->
        <div
          id="view-selection"
          class="px-8 py-8 pb-6 transition-all duration-300"
        >
          <h3 class="text-2xl font-bold text-center text-zinc-900 mb-6">
            Zahlung wählen
          </h3>

          <!-- KUNDEN SELEKTOR -->
          <div
            id="customer-selector"
            class="flex items-center justify-between p-3 mb-6 bg-zinc-50 rounded-xl border border-zinc-200 cursor-pointer hover:bg-zinc-100 transition-colors"
          >
            <div id="no-customer" class="flex items-center gap-3 text-zinc-500">
              <div
                class="w-10 h-10 rounded-full bg-zinc-200 flex items-center justify-center text-zinc-400"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                  ></path></svg
                >
              </div>
              <div class="text-left">
                <div class="text-sm font-bold text-zinc-800">
                  Anonymer Kunde
                </div>
                <div class="text-xs">Ticket (Simplificada)</div>
              </div>
            </div>
            <div
              id="has-customer"
              class="hidden flex items-center gap-3 text-zinc-900"
            >
              <div
                class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                  ></path></svg
                >
              </div>
              <div class="text-left">
                <div
                  id="cust-display-name"
                  class="text-sm font-bold text-blue-800 truncate max-w-[150px]"
                >
                  Kundenname
                </div>
                <div class="text-xs text-blue-600">Rechnung (Completa)</div>
              </div>
            </div>
            <button class="text-sm font-bold text-blue-600 hover:underline pl-2"
              >Ändern</button
            >
          </div>

          <!-- PREIS -->
          <div
            class="mb-8 py-4 bg-zinc-900 rounded-2xl border border-zinc-900 text-center shadow-lg"
          >
            <span
              class="text-zinc-400 text-xs font-bold uppercase tracking-wide"
              >Zu zahlen</span
            >
            <div
              class="display-total text-5xl font-extrabold text-white tracking-tight mt-1"
            >
              0.00 €
            </div>
          </div>

          <!-- DRUCK TOGGLE -->
          <div
            class="flex items-center justify-between mb-4 bg-zinc-50 p-3 rounded-xl border border-zinc-100 print-toggle-container cursor-pointer select-none"
          >
            <div class="flex items-center gap-2">
              <div
                class="bg-white p-2 rounded-full border border-zinc-200 text-zinc-500"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"
                  ></path></svg
                >
              </div>
              <span class="text-sm font-bold text-zinc-700">Bon drucken</span>
            </div>
            <div
              class="toggle-print-ui relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none bg-blue-600"
            >
              <span
                class="toggle-print-knob inline-block h-4 w-4 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-6"
              ></span>
            </div>
          </div>

          <!-- BUTTONS -->
          <div class="grid grid-cols-2 gap-4">
            <button
              id="btn-cash-start"
              class="group flex flex-col items-center justify-center p-6 rounded-2xl border-2 border-zinc-100 hover:border-blue-500 hover:bg-blue-50 transition-all active:scale-95 shadow-sm"
            >
              <div
                class="h-12 w-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform"
              >
                <svg
                  class="w-6 h-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"
                  ></path></svg
                >
              </div>
              <span class="font-bold text-zinc-700 group-hover:text-blue-700"
                >Barzahlung</span
              >
            </button>
            <button
              id="btn-card-pay"
              class="group flex flex-col items-center justify-center p-6 rounded-2xl border-2 border-zinc-100 hover:border-purple-500 hover:bg-purple-50 transition-all active:scale-95 shadow-sm"
            >
              <div
                class="h-12 w-12 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform"
              >
                <svg
                  class="w-6 h-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"
                  ></path></svg
                >
              </div>
              <span class="font-bold text-zinc-700 group-hover:text-purple-700"
                >Karte</span
              >
            </button>
          </div>
        </div>

        <!-- ============================================ -->
        <!-- VIEW 2: BARGELD EINGABE (NUMPAD)             -->
        <!-- ============================================ -->
        <div id="view-cash" class="hidden px-6 py-6 h-full flex flex-col">
          <!-- HEADER -->
          <div class="mb-4">
            <button
              id="back-to-selection"
              class="text-sm font-bold text-zinc-500 hover:text-zinc-800 flex items-center gap-1 py-2 pr-4 pl-0"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 19l-7-7 7-7"></path></svg
              >
              Zurück zur Auswahl
            </button>
          </div>

          <!-- Display -->
          <div class="bg-zinc-900 rounded-2xl p-4 mb-4 text-right shadow-inner">
            <p class="text-zinc-400 text-xs uppercase font-bold mb-1">
              Gegeben
            </p>
            <div
              id="cash-input-display"
              class="text-4xl font-mono text-white mb-2 tracking-tight"
            >
              0.00 €
            </div>
            <div class="h-px bg-zinc-700 w-full my-2"></div>
            <div class="flex justify-between items-end">
              <span class="text-zinc-400 text-sm">Rückgeld:</span>
              <span
                id="change-display"
                class="text-2xl font-bold text-emerald-400">0.00 €</span
              >
            </div>
          </div>

          <!-- Druck Toggle -->
          <div
            class="flex items-center justify-between mb-4 bg-zinc-50 p-3 rounded-xl border border-zinc-100 print-toggle-container cursor-pointer select-none"
          >
            <div class="flex items-center gap-2">
              <div
                class="bg-white p-2 rounded-full border border-zinc-200 text-zinc-500"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"
                  ></path></svg
                >
              </div>
              <span class="text-sm font-bold text-zinc-700">Bon drucken</span>
            </div>
            <div
              class="toggle-print-ui relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none bg-blue-600"
            >
              <span
                class="toggle-print-knob inline-block h-4 w-4 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-6"
              ></span>
            </div>
          </div>

          <!-- Numpad -->
          <div class="grid grid-cols-3 gap-3 mb-4 select-none">
            <button
              class="quick-cash col-span-1 bg-blue-50 text-blue-700 font-bold py-3 rounded-xl hover:bg-blue-100 border border-blue-100"
              data-amount="5">5€</button
            >
            <button
              class="quick-cash col-span-1 bg-blue-50 text-blue-700 font-bold py-3 rounded-xl hover:bg-blue-100 border border-blue-100"
              data-amount="10">10€</button
            >
            <button
              class="quick-cash col-span-1 bg-blue-50 text-blue-700 font-bold py-3 rounded-xl hover:bg-blue-100 border border-blue-100"
              data-amount="20">20€</button
            >
            <button
              class="quick-cash col-span-1 bg-blue-50 text-blue-700 font-bold py-3 rounded-xl hover:bg-blue-100 border border-blue-100"
              data-amount="50">50€</button
            >
            <button
              class="quick-cash col-span-1 bg-blue-50 text-blue-700 font-bold py-3 rounded-xl hover:bg-blue-100 border border-blue-100"
              data-amount="100">100€</button
            >
            <button
              class="quick-cash col-span-1 bg-blue-50 text-blue-700 font-bold py-3 rounded-xl hover:bg-blue-100 border border-blue-100"
              data-amount="200">200€</button
            >

            {
              [1, 2, 3, 4, 5, 6, 7, 8, 9].map((num) => (
                <button
                  class="numpad-btn bg-white border border-zinc-200 text-2xl font-medium py-3 rounded-xl hover:bg-zinc-50 active:scale-95 shadow-sm text-zinc-700"
                  data-val={num}
                >
                  {num}
                </button>
              ))
            }
            <button
              class="numpad-btn bg-white border border-zinc-200 text-2xl font-medium py-3 rounded-xl hover:bg-zinc-50 active:scale-95 shadow-sm text-zinc-700"
              data-val="0">0</button
            >
            <button
              class="numpad-btn bg-white border border-zinc-200 text-2xl font-medium py-3 rounded-xl hover:bg-zinc-50 active:scale-95 shadow-sm text-zinc-700"
              data-val="00">00</button
            >
            <button
              id="numpad-clear"
              class="bg-red-50 text-red-600 text-xl font-bold py-3 rounded-xl hover:bg-red-100 active:scale-95 border border-red-100"
              >C</button
            >
          </div>

          <button
            id="confirm-cash-btn"
            class="w-full bg-emerald-600 text-white font-bold text-xl py-4 rounded-2xl shadow-lg shadow-emerald-200 disabled:opacity-50 disabled:cursor-not-allowed transition-all active:scale-[0.98]"
            disabled
          >
            Bestätigen
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  import {
    isPaymentModalOpen,
    isCustomerModalOpen,
    cartTotals,
    completeTransaction,
    selectedCustomer,
    shouldPrintReceipt,
  } from "../stores/cartStore";

  // --- SICHERE ELEMENT SELEKTION ---
  // Wir nutzen getElementById, erlauben aber null.
  // Das '!' am Ende wurde entfernt, um Abstürze zu vermeiden.

  const modal = document.getElementById("payment-modal");
  const backdrop = document.getElementById("modal-backdrop");
  const panel = document.getElementById("modal-panel");

  const closeModalContainer = document.getElementById("close-modal-container");
  const closeBtnX = document.getElementById("close-modal-x");

  const viewSelection = document.getElementById("view-selection");
  const viewCash = document.getElementById("view-cash");

  const customerSelector = document.getElementById("customer-selector");
  const noCustomerDiv = document.getElementById("no-customer");
  const hasCustomerDiv = document.getElementById("has-customer");
  const custDisplayName = document.getElementById("cust-display-name");

  const totalDisplays = document.querySelectorAll(".display-total");
  const inputDisplay = document.getElementById("cash-input-display");
  const changeDisplay = document.getElementById("change-display");

  const btnCashStart = document.getElementById("btn-cash-start");
  const btnCardPay = document.getElementById("btn-card-pay");

  // Wichtig: Type Casting für disabled Property, aber sicher
  const btnConfirm = document.getElementById(
    "confirm-cash-btn"
  ) as HTMLButtonElement | null;

  const btnBack = document.getElementById("back-to-selection");
  const btnClear = document.getElementById("numpad-clear");
  const numpadBtns = document.querySelectorAll(".numpad-btn");
  const quickBtns = document.querySelectorAll(".quick-cash");

  const toggleContainers = document.querySelectorAll(".print-toggle-container");
  const toggleUIs = document.querySelectorAll(".toggle-print-ui");
  const toggleKnobs = document.querySelectorAll(".toggle-print-knob");

  let currentTotal = 0;
  let inputCents = 0;

  // --- VIEW LOGIC (Mit Safe Checks) ---
  function showView(viewName: "selection" | "cash") {
    if (viewName === "selection") {
      viewSelection?.classList.remove("hidden");
      viewCash?.classList.add("hidden");
      closeModalContainer?.classList.remove("hidden");
    } else {
      viewSelection?.classList.add("hidden");
      viewCash?.classList.remove("hidden");
      closeModalContainer?.classList.add("hidden");
      updateNumpadDisplay();
    }
  }

  // --- VISIBILITY ---
  isPaymentModalOpen.subscribe((isOpen) => {
    if (isOpen) {
      modal?.classList.remove("hidden");
      resetCashView();
      showView("selection");
      setTimeout(() => {
        backdrop?.classList.remove("opacity-0");
        panel?.classList.remove(
          "opacity-0",
          "translate-y-4",
          "sm:translate-y-0",
          "sm:scale-95"
        );
      }, 10);
    } else {
      backdrop?.classList.add("opacity-0");
      panel?.classList.add(
        "opacity-0",
        "translate-y-4",
        "sm:translate-y-0",
        "sm:scale-95"
      );
      setTimeout(() => modal?.classList.add("hidden"), 300);
    }
  });

  closeBtnX?.addEventListener("click", () => isPaymentModalOpen.set(false));

  // --- NAVIGATION ---
  btnCashStart?.addEventListener("click", () => showView("cash"));
  btnBack?.addEventListener("click", () => showView("selection"));

  // --- ACTIONS ---
  btnCardPay?.addEventListener("click", () => {
    completeTransaction(
      currentTotal.toFixed(2),
      currentTotal.toFixed(2),
      "card"
    );
  });

  btnConfirm?.addEventListener("click", () => {
    const tenderedStr = (inputCents / 100).toFixed(2);
    const totalStr = currentTotal.toFixed(2);
    completeTransaction(totalStr, tenderedStr, "cash");
  });

  // --- NUMPAD ---
  function resetCashView() {
    inputCents = 0;
    updateNumpadDisplay();
  }

  function updateNumpadDisplay() {
    const valInEuro = inputCents / 100;

    if (inputDisplay) inputDisplay.textContent = valInEuro.toFixed(2) + " €";

    const change = valInEuro - currentTotal;

    if (change >= -0.005) {
      if (changeDisplay) {
        changeDisplay.textContent = change.toFixed(2) + " €";
        changeDisplay.classList.remove("text-red-400");
        changeDisplay.classList.add("text-emerald-400");
      }

      if (btnConfirm) {
        btnConfirm.disabled = false;
        btnConfirm.innerHTML = `Rückgeld: ${change.toFixed(2)}€ • Fertig`;
        btnConfirm.classList.add("animate-pulse-slow");
      }
    } else {
      if (changeDisplay) {
        changeDisplay.textContent = change.toFixed(2) + " €";
        changeDisplay.classList.remove("text-emerald-400");
        changeDisplay.classList.add("text-red-400");
      }

      if (btnConfirm) {
        btnConfirm.disabled = true;
        btnConfirm.innerHTML = "Betrag zu gering";
        btnConfirm.classList.remove("animate-pulse-slow");
      }
    }
  }

  numpadBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      const val = btn.getAttribute("data-val");
      if (inputCents.toString().length > 6) return;
      if (val === "00") inputCents = inputCents * 100;
      else inputCents = inputCents * 10 + parseInt(val!);
      updateNumpadDisplay();
    });
  });

  quickBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      const amount = btn.getAttribute("data-amount");
      if (amount) {
        inputCents = parseInt(amount) * 100;
        updateNumpadDisplay();
      }
    });
  });

  btnClear?.addEventListener("click", () => {
    inputCents = 0;
    updateNumpadDisplay();
  });

  // --- CUSTOMER & TOTALS ---
  customerSelector?.addEventListener("click", () =>
    isCustomerModalOpen.set(true)
  );

  selectedCustomer.subscribe((cust) => {
    if (cust) {
      noCustomerDiv?.classList.add("hidden");
      hasCustomerDiv?.classList.remove("hidden");
      hasCustomerDiv?.classList.add("flex");
      if (custDisplayName) custDisplayName.innerText = cust.name;

      customerSelector?.classList.add("border-blue-200", "bg-blue-50");
      customerSelector?.classList.remove("border-zinc-200", "bg-zinc-50");
    } else {
      noCustomerDiv?.classList.remove("hidden");
      hasCustomerDiv?.classList.add("hidden");
      hasCustomerDiv?.classList.remove("flex");

      customerSelector?.classList.remove("border-blue-200", "bg-blue-50");
      customerSelector?.classList.add("border-zinc-200", "bg-zinc-50");
    }
  });

  cartTotals.subscribe((t) => {
    currentTotal = parseFloat(t.gross);
    totalDisplays.forEach((el) => (el.textContent = `${t.gross} €`));
  });

  // --- TOGGLE ---
  shouldPrintReceipt.subscribe((val) => {
    if (val) {
      toggleUIs.forEach((el) =>
        el.classList.replace("bg-zinc-200", "bg-blue-600")
      );
      toggleKnobs.forEach((el) =>
        el.classList.replace("translate-x-1", "translate-x-6")
      );
    } else {
      toggleUIs.forEach((el) =>
        el.classList.replace("bg-blue-600", "bg-zinc-200")
      );
      toggleKnobs.forEach((el) =>
        el.classList.replace("translate-x-6", "translate-x-1")
      );
    }
  });

  toggleContainers.forEach((container) => {
    container.addEventListener("click", () => {
      const current = shouldPrintReceipt.get();
      shouldPrintReceipt.set(!current);
    });
  });
</script>

<style>
  .animate-pulse-slow {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.9;
    }
  }
</style>
