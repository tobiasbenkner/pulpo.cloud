---
// apps/shop/src/components/CashClosureModal.astro
---

<div
  id="closure-modal"
  class="fixed inset-0 z-50 hidden"
  role="dialog"
  aria-modal="true"
>
  <!-- Backdrop -->
  <div
    class="fixed inset-0 bg-zinc-900/40 backdrop-blur-md transition-opacity opacity-0"
    id="closure-backdrop"
  ></div>

  <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
    <div
      class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0"
    >
      <!-- Modal Panel -->
      <div
        class="relative transform overflow-hidden rounded-3xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        id="closure-panel"
      >
        <!-- Close Button -->
        <div class="absolute right-4 top-4 z-20" id="closure-close-container">
          <button
            id="closure-close-x"
            class="rounded-full p-2 bg-zinc-100 text-zinc-400 hover:text-zinc-600 transition-colors"
          >
            <svg
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="2"
              stroke="currentColor"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M6 18L18 6M6 6l12 12"></path></svg
            >
          </button>
        </div>

        <!-- ============================= -->
        <!-- VIEW: LOADING                 -->
        <!-- ============================= -->
        <div
          id="closure-view-loading"
          class="px-8 py-12 flex flex-col items-center justify-center"
        >
          <div
            class="w-10 h-10 border-2 border-zinc-300 border-t-zinc-600 rounded-full animate-spin mb-4"
          ></div>
          <p class="text-sm text-zinc-400">Daten werden geladen...</p>
        </div>

        <!-- ============================= -->
        <!-- VIEW: WARNING (parked/active) -->
        <!-- ============================= -->
        <div id="closure-view-warning" class="hidden px-8 py-8">
          <div class="flex justify-center mb-4">
            <div
              class="w-14 h-14 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center"
            >
              <svg
                class="w-7 h-7"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4.5c-.77-.833-2.694-.833-3.464 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"
                ></path></svg
              >
            </div>
          </div>
          <h3
            class="text-xl font-bold text-center text-zinc-900 mb-3"
          >
            Achtung
          </h3>
          <p
            id="closure-warning-text"
            class="text-sm text-center text-zinc-500 mb-6"
          >
          </p>
          <div class="flex gap-3">
            <button
              id="closure-warning-cancel"
              class="flex-1 py-3 rounded-xl border-2 border-zinc-200 text-zinc-600 font-bold text-sm hover:bg-zinc-50 transition-colors"
            >
              Abbrechen
            </button>
            <button
              id="closure-warning-continue"
              class="flex-1 py-3 rounded-xl bg-amber-500 text-white font-bold text-sm hover:bg-amber-600 transition-colors"
            >
              Trotzdem fortfahren
            </button>
          </div>
        </div>

        <!-- ============================= -->
        <!-- VIEW 1: ZUSAMMENFASSUNG       -->
        <!-- ============================= -->
        <div id="closure-view-summary" class="hidden px-8 py-8">
          <h3
            class="text-2xl font-bold text-center text-zinc-900 mb-6"
          >
            Kassenschlie&szlig;ung
          </h3>

          <!-- Period -->
          <div class="bg-zinc-50 rounded-xl p-4 mb-4 border border-zinc-100">
            <div class="flex justify-between text-sm mb-1">
              <span class="text-zinc-400">Von</span>
              <span id="closure-period-start" class="text-zinc-700 font-medium"
              ></span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-zinc-400">Bis</span>
              <span id="closure-period-end" class="text-zinc-700 font-medium"
              ></span>
            </div>
          </div>

          <!-- Totals -->
          <div class="space-y-2 mb-4">
            <div class="flex justify-between text-sm">
              <span class="text-zinc-500">Transaktionen</span>
              <span
                id="closure-tx-count"
                class="font-bold text-zinc-900"></span>
            </div>
            <div class="h-px bg-zinc-100"></div>
            <div class="flex justify-between text-sm">
              <span class="text-zinc-500">Brutto</span>
              <span
                id="closure-total-gross"
                class="font-bold text-zinc-900"></span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-zinc-500">Netto</span>
              <span id="closure-total-net" class="font-medium text-zinc-700"
              ></span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-zinc-500">Steuer</span>
              <span id="closure-total-tax" class="font-medium text-zinc-700"
              ></span>
            </div>
            <div class="h-px bg-zinc-100"></div>
            <div class="flex justify-between text-sm">
              <span class="text-zinc-500">Bar</span>
              <span id="closure-total-cash" class="font-medium text-zinc-700"
              ></span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-zinc-500">Karte</span>
              <span id="closure-total-card" class="font-medium text-zinc-700"
              ></span>
            </div>
          </div>

          <!-- Tax Breakdown -->
          <div
            id="closure-tax-breakdown"
            class="bg-zinc-50 rounded-xl p-4 mb-6 border border-zinc-100 space-y-1"
          >
          </div>

          <button
            id="closure-btn-next"
            class="w-full bg-zinc-900 text-white font-bold text-lg py-4 rounded-2xl shadow-lg hover:bg-black active:scale-[0.98] transition-all"
          >
            Weiter zur Z&auml;hlung
          </button>
        </div>

        <!-- ============================= -->
        <!-- VIEW 2: BARGELDZÄHLUNG        -->
        <!-- ============================= -->
        <div id="closure-view-count" class="hidden px-6 py-6 flex flex-col relative">
          <!-- Back -->
          <div class="mb-4">
            <button
              id="closure-back-to-summary"
              class="text-sm font-bold text-zinc-500 hover:text-zinc-800 flex items-center gap-1 py-2 pr-4 pl-0"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 19l-7-7 7-7"></path></svg
              >
              Zur&uuml;ck
            </button>
          </div>

          <!-- Expected / Counted / Difference -->
          <div class="bg-zinc-900 rounded-2xl p-4 mb-4 shadow-inner">
            <div class="flex justify-between items-end mb-3">
              <span class="text-zinc-400 text-xs uppercase font-bold"
                >Soll (erwartet)</span
              >
              <span
                id="closure-expected-cash"
                class="text-xl font-mono text-white">0.00 &euro;</span
              >
            </div>
            <div class="h-px bg-zinc-700 my-2"></div>
            <div class="flex justify-between items-end mb-3">
              <span class="text-zinc-400 text-xs uppercase font-bold"
                >Gez&auml;hlt</span
              >
              <span
                id="closure-counted-display"
                class="text-3xl font-mono text-white">0.00 &euro;</span
              >
            </div>
            <div class="h-px bg-zinc-700 my-2"></div>
            <div class="flex justify-between items-end">
              <span class="text-zinc-400 text-xs uppercase font-bold"
                >Differenz</span
              >
              <span
                id="closure-difference-display"
                class="text-xl font-bold text-zinc-400">0.00 &euro;</span
              >
            </div>
          </div>

          <!-- Denomination Counting -->
          <div id="closure-denom-list" class="max-h-[340px] overflow-y-auto mb-4 -mx-1 px-1">
            <!-- Bills -->
            <div class="mb-3">
              <div class="text-[10px] font-bold text-zinc-400 uppercase tracking-widest mb-2">Scheine</div>
              <div class="space-y-1.5">
                {[500, 200, 100, 50, 20, 10, 5].map((val) => (
                  <div class="denom-row flex items-center gap-2" data-cents={val * 100}>
                    <span class="w-14 text-sm font-bold text-zinc-700 text-right">{val} &euro;</span>
                    <button class="denom-minus w-8 h-8 flex items-center justify-center rounded-lg bg-zinc-100 text-zinc-500 hover:bg-zinc-200 active:scale-95 transition-colors text-lg font-bold leading-none">&minus;</button>
                    <span class="denom-qty w-10 text-center text-sm font-bold text-zinc-900 tabular-nums cursor-pointer hover:bg-blue-50 hover:text-blue-700 rounded-lg py-1 transition-colors select-none">0</span>
                    <button class="denom-plus w-8 h-8 flex items-center justify-center rounded-lg bg-zinc-100 text-zinc-500 hover:bg-zinc-200 active:scale-95 transition-colors text-lg font-bold leading-none">+</button>
                    <span class="denom-subtotal flex-1 text-right text-sm font-mono text-zinc-400">0.00</span>
                  </div>
                ))}
              </div>
            </div>
            <!-- Coins -->
            <div>
              <div class="text-[10px] font-bold text-zinc-400 uppercase tracking-widest mb-2">M&uuml;nzen</div>
              <div class="space-y-1.5">
                {[200, 100, 50, 20, 10, 5, 2, 1].map((cents) => {
                  const label = cents >= 100 ? `${cents / 100} \u20AC` : `${cents} ct`;
                  return (
                    <div class="denom-row flex items-center gap-2" data-cents={cents}>
                      <span class="w-14 text-sm font-bold text-zinc-700 text-right">{label}</span>
                      <button class="denom-minus w-8 h-8 flex items-center justify-center rounded-lg bg-zinc-100 text-zinc-500 hover:bg-zinc-200 active:scale-95 transition-colors text-lg font-bold leading-none">&minus;</button>
                      <span class="denom-qty w-10 text-center text-sm font-bold text-zinc-900 tabular-nums cursor-pointer hover:bg-blue-50 hover:text-blue-700 rounded-lg py-1 transition-colors select-none">0</span>
                      <button class="denom-plus w-8 h-8 flex items-center justify-center rounded-lg bg-zinc-100 text-zinc-500 hover:bg-zinc-200 active:scale-95 transition-colors text-lg font-bold leading-none">+</button>
                      <span class="denom-subtotal flex-1 text-right text-sm font-mono text-zinc-400">0.00</span>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>

          <!-- Reset -->
          <button
            id="closure-denom-reset"
            class="w-full mb-3 py-2 rounded-xl border-2 border-dashed border-zinc-300 text-zinc-500 font-bold text-sm hover:border-zinc-400 hover:bg-zinc-50 transition-colors"
          >
            Zur&uuml;cksetzen
          </button>

          <!-- Print Toggle -->
          <div
            class="flex items-center justify-between mb-4 bg-zinc-50 p-3 rounded-xl border border-zinc-100 cursor-pointer select-none"
            id="closure-print-toggle"
          >
            <div class="flex items-center gap-2">
              <div
                class="bg-white p-2 rounded-full border border-zinc-200 text-zinc-500"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"
                  ></path></svg
                >
              </div>
              <span class="text-sm font-bold text-zinc-700">Bon drucken</span>
            </div>
            <div
              id="closure-print-toggle-ui"
              class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none bg-blue-600"
            >
              <span
                id="closure-print-toggle-knob"
                class="inline-block h-4 w-4 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-6"
              ></span>
            </div>
          </div>

          <button
            id="closure-btn-finalize"
            class="w-full bg-emerald-600 text-white font-bold text-xl py-4 rounded-2xl shadow-lg shadow-emerald-200 transition-all active:scale-[0.98]"
          >
            Abschlie&szlig;en
          </button>

          <!-- ============================= -->
          <!-- QTY NUMPAD OVERLAY            -->
          <!-- ============================= -->
          <div
            id="qty-numpad-overlay"
            class="hidden absolute inset-0 z-40 bg-white/95 backdrop-blur-sm flex flex-col px-6 py-6"
          >
            <!-- Header -->
            <div class="flex items-center justify-between mb-4">
              <button
                id="qty-numpad-cancel"
                class="text-sm font-bold text-zinc-500 hover:text-zinc-800 flex items-center gap-1 py-2 pr-4 pl-0"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"></path></svg
                >
                Abbrechen
              </button>
              <span
                id="qty-numpad-label"
                class="text-sm font-bold text-zinc-900"
              ></span>
            </div>

            <!-- Display -->
            <div
              class="bg-zinc-900 rounded-2xl p-5 mb-5 text-center shadow-inner"
            >
              <p
                class="text-zinc-400 text-xs uppercase font-bold mb-1 tracking-wide"
              >
                Anzahl
              </p>
              <div
                id="qty-numpad-display"
                class="text-5xl font-mono text-white tracking-tight"
              >
                0
              </div>
            </div>

            <!-- Numpad -->
            <div class="grid grid-cols-3 gap-3 mb-4 select-none flex-1">
              {
                [1, 2, 3, 4, 5, 6, 7, 8, 9].map((num) => (
                  <button
                    class="qty-numpad-btn bg-white border border-zinc-200 text-2xl font-medium rounded-xl hover:bg-zinc-50 active:scale-95 shadow-sm text-zinc-700"
                    data-val={num}
                  >
                    {num}
                  </button>
                ))
              }
              <button
                id="qty-numpad-clear"
                class="bg-red-50 text-red-600 text-xl font-bold rounded-xl hover:bg-red-100 active:scale-95 border border-red-100"
                >C</button
              >
              <button
                class="qty-numpad-btn bg-white border border-zinc-200 text-2xl font-medium rounded-xl hover:bg-zinc-50 active:scale-95 shadow-sm text-zinc-700"
                data-val="0">0</button
              >
              <button
                id="qty-numpad-backspace"
                class="bg-zinc-50 text-zinc-600 text-xl font-bold rounded-xl hover:bg-zinc-100 active:scale-95 border border-zinc-200 flex items-center justify-center"
              >
                <svg
                  class="w-6 h-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 12l6.414-6.414A2 2 0 0110.828 5H19a2 2 0 012 2v10a2 2 0 01-2 2h-8.172a2 2 0 01-1.414-.586L3 12z"
                  ></path></svg
                >
              </button>
            </div>

            <button
              id="qty-numpad-confirm"
              class="w-full bg-blue-600 text-white font-bold text-xl py-4 rounded-2xl shadow-lg shadow-blue-200 transition-all active:scale-[0.98] hover:bg-blue-700"
            >
              &Uuml;bernehmen
            </button>
          </div>
        </div>

        <!-- ============================= -->
        <!-- VIEW 3: BESTÄTIGUNG           -->
        <!-- ============================= -->
        <div id="closure-view-done" class="hidden px-8 py-8">
          <div class="flex justify-center mb-4">
            <div
              class="w-16 h-16 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center"
            >
              <svg
                class="w-8 h-8"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5 13l4 4L19 7"></path></svg
              >
            </div>
          </div>
          <h3
            class="text-2xl font-bold text-center text-zinc-900 mb-2"
          >
            Kasse geschlossen
          </h3>
          <p
            id="closure-done-difference"
            class="text-center text-lg font-bold mb-6"
          >
          </p>
          <button
            id="closure-btn-ok"
            class="w-full bg-zinc-900 text-white font-bold text-lg py-4 rounded-2xl shadow-lg hover:bg-black active:scale-[0.98] transition-all"
          >
            OK
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  import {
    isClosureModalOpen,
    closureReport,
    closureLoading,
    generateClosureReport,
    finalizeClosure,
  } from "../stores/registerStore";
  import { cartItems, parkedCarts } from "../stores/cartStore";
  import { printClosureReport } from "../stores/printerStore";
  import Big from "big.js";

  const modal = document.getElementById("closure-modal");
  const backdrop = document.getElementById("closure-backdrop");
  const panel = document.getElementById("closure-panel");
  const closeContainer = document.getElementById("closure-close-container");
  const closeBtn = document.getElementById("closure-close-x");

  // Views
  const viewLoading = document.getElementById("closure-view-loading");
  const viewWarning = document.getElementById("closure-view-warning");
  const viewSummary = document.getElementById("closure-view-summary");
  const viewCount = document.getElementById("closure-view-count");
  const viewDone = document.getElementById("closure-view-done");

  // Warning
  const warningText = document.getElementById("closure-warning-text");
  const warningCancel = document.getElementById("closure-warning-cancel");
  const warningContinue = document.getElementById("closure-warning-continue");

  // Summary
  const periodStartEl = document.getElementById("closure-period-start");
  const periodEndEl = document.getElementById("closure-period-end");
  const txCountEl = document.getElementById("closure-tx-count");
  const totalGrossEl = document.getElementById("closure-total-gross");
  const totalNetEl = document.getElementById("closure-total-net");
  const totalTaxEl = document.getElementById("closure-total-tax");
  const totalCashEl = document.getElementById("closure-total-cash");
  const totalCardEl = document.getElementById("closure-total-card");
  const taxBreakdownEl = document.getElementById("closure-tax-breakdown");
  const btnNext = document.getElementById("closure-btn-next");

  // Count
  const backToSummary = document.getElementById("closure-back-to-summary");
  const expectedCashEl = document.getElementById("closure-expected-cash");
  const countedDisplay = document.getElementById("closure-counted-display");
  const differenceDisplay = document.getElementById(
    "closure-difference-display",
  );
  const denomRows = document.querySelectorAll(".denom-row");
  const denomResetBtn = document.getElementById("closure-denom-reset");
  const btnFinalize = document.getElementById(
    "closure-btn-finalize",
  ) as HTMLButtonElement | null;

  // Print toggle
  const printToggle = document.getElementById("closure-print-toggle");
  const printToggleUI = document.getElementById("closure-print-toggle-ui");
  const printToggleKnob = document.getElementById("closure-print-toggle-knob");

  // Done
  const doneDifference = document.getElementById("closure-done-difference");
  const btnOk = document.getElementById("closure-btn-ok");

  // Denomination quantities: keyed by cents value
  const denomQtys = new Map<number, number>();
  let expectedCashValue = 0;
  let shouldPrint = true;

  function showView(view: "loading" | "warning" | "summary" | "count" | "done") {
    viewLoading?.classList.add("hidden");
    viewWarning?.classList.add("hidden");
    viewSummary?.classList.add("hidden");
    viewCount?.classList.add("hidden");
    viewDone?.classList.add("hidden");

    if (view === "loading") {
      viewLoading?.classList.remove("hidden");
      closeContainer?.classList.remove("hidden");
    } else if (view === "warning") {
      viewWarning?.classList.remove("hidden");
      closeContainer?.classList.remove("hidden");
    } else if (view === "summary") {
      viewSummary?.classList.remove("hidden");
      closeContainer?.classList.remove("hidden");
    } else if (view === "count") {
      viewCount?.classList.remove("hidden");
      closeContainer?.classList.add("hidden");
    } else if (view === "done") {
      viewDone?.classList.remove("hidden");
      closeContainer?.classList.add("hidden");
    }
  }

  function formatDateStr(iso: string): string {
    const d = new Date(iso);
    return (
      d.toLocaleDateString("de-DE", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
      }) +
      " " +
      d.toLocaleTimeString("de-DE", {
        hour: "2-digit",
        minute: "2-digit",
      })
    );
  }

  function closeModal() {
    isClosureModalOpen.set(false);
  }

  function openModal() {
    modal?.classList.remove("hidden");
    setTimeout(() => {
      backdrop?.classList.remove("opacity-0");
      panel?.classList.remove(
        "opacity-0",
        "translate-y-4",
        "sm:translate-y-0",
        "sm:scale-95",
      );
    }, 10);
  }

  function hideModal() {
    backdrop?.classList.add("opacity-0");
    panel?.classList.add(
      "opacity-0",
      "translate-y-4",
      "sm:translate-y-0",
      "sm:scale-95",
    );
    setTimeout(() => modal?.classList.add("hidden"), 300);
  }

  // Check for warnings before proceeding
  function checkWarnings(): string | null {
    const warnings: string[] = [];
    const items = cartItems.get();
    const parked = parkedCarts.get();

    if (Object.keys(items).length > 0) {
      warnings.push("Der aktuelle Warenkorb ist nicht leer.");
    }
    if (Object.keys(parked).length > 0) {
      const count = Object.keys(parked).length;
      warnings.push(
        `Es gibt ${count} geparkte${count === 1 ? "n" : ""} Warenk${count === 1 ? "orb" : "örbe"}.`,
      );
    }

    return warnings.length > 0 ? warnings.join("\n") : null;
  }

  async function loadAndShowSummary() {
    showView("loading");

    try {
      const report = await generateClosureReport();
      populateSummary(report);
      showView("summary");
    } catch {
      closeModal();
    }
  }

  function populateSummary(report: any) {
    if (periodStartEl) periodStartEl.textContent = formatDateStr(report.periodStart);
    if (periodEndEl) periodEndEl.textContent = formatDateStr(report.periodEnd);
    if (txCountEl) txCountEl.textContent = report.transactionCount.toString();
    if (totalGrossEl)
      totalGrossEl.textContent = `${report.totalGross} EUR`;
    if (totalNetEl) totalNetEl.textContent = `${report.totalNet} EUR`;
    if (totalTaxEl) totalTaxEl.textContent = `${report.totalTax} EUR`;
    if (totalCashEl) totalCashEl.textContent = `${report.totalCash} EUR`;
    if (totalCardEl) totalCardEl.textContent = `${report.totalCard} EUR`;

    if (taxBreakdownEl) {
      if (report.taxBreakdown.length > 0) {
        taxBreakdownEl.classList.remove("hidden");
        taxBreakdownEl.innerHTML = report.taxBreakdown
          .map(
            (entry: any) =>
              `<div class="flex justify-between text-sm">
                <span class="text-zinc-500">IGIC ${parseFloat(entry.rate).toFixed(0)}%</span>
                <span class="text-zinc-700 font-mono">Base ${entry.net} &nbsp; Imp. ${entry.tax}</span>
              </div>`,
          )
          .join("");
      } else {
        taxBreakdownEl.classList.add("hidden");
      }
    }

    // Prepare count view
    expectedCashValue = parseFloat(report.expectedCash);
    if (expectedCashEl)
      expectedCashEl.textContent = `${report.expectedCash} \u20AC`;
  }

  function getTotalCents(): number {
    let total = 0;
    denomQtys.forEach((qty, cents) => {
      total += qty * cents;
    });
    return total;
  }

  function updateCountDisplay() {
    const totalCents = getTotalCents();
    const counted = totalCents / 100;
    if (countedDisplay) countedDisplay.textContent = `${counted.toFixed(2)} \u20AC`;

    const diff = counted - expectedCashValue;
    if (differenceDisplay) {
      const sign = diff >= 0 ? "+" : "";
      differenceDisplay.textContent = `${sign}${diff.toFixed(2)} \u20AC`;
      differenceDisplay.classList.remove(
        "text-emerald-400",
        "text-red-400",
        "text-zinc-400",
      );
      if (Math.abs(diff) < 0.005) {
        differenceDisplay.classList.add("text-zinc-400");
      } else if (diff > 0) {
        differenceDisplay.classList.add("text-emerald-400");
      } else {
        differenceDisplay.classList.add("text-red-400");
      }
    }

    // Update per-row subtotals
    denomRows.forEach((row) => {
      const cents = parseInt(row.getAttribute("data-cents") ?? "0");
      const qty = denomQtys.get(cents) ?? 0;
      const qtyEl = row.querySelector(".denom-qty");
      const subtotalEl = row.querySelector(".denom-subtotal");
      if (qtyEl) qtyEl.textContent = String(qty);
      if (subtotalEl) {
        const sub = (qty * cents) / 100;
        subtotalEl.textContent = sub.toFixed(2);
        (subtotalEl as HTMLElement).classList.toggle("text-zinc-900", sub > 0);
        (subtotalEl as HTMLElement).classList.toggle("text-zinc-400", sub === 0);
      }
    });
  }

  function resetDenominations() {
    denomQtys.clear();
    updateCountDisplay();
  }

  // --- EVENT: OPEN/CLOSE ---
  isClosureModalOpen.subscribe((isOpen) => {
    if (isOpen) {
      resetDenominations();
      shouldPrint = true;
      updatePrintToggle();
      openModal();

      const warning = checkWarnings();
      if (warning) {
        if (warningText) warningText.textContent = warning;
        showView("warning");
      } else {
        loadAndShowSummary();
      }
    } else {
      hideModal();
    }
  });

  closeBtn?.addEventListener("click", closeModal);

  // --- WARNING ---
  warningCancel?.addEventListener("click", closeModal);
  warningContinue?.addEventListener("click", () => loadAndShowSummary());

  // --- SUMMARY -> COUNT ---
  btnNext?.addEventListener("click", () => {
    resetDenominations();
    showView("count");
  });

  backToSummary?.addEventListener("click", () => showView("summary"));

  // --- DENOMINATION COUNTING ---
  denomRows.forEach((row) => {
    const cents = parseInt(row.getAttribute("data-cents") ?? "0");
    const plusBtn = row.querySelector(".denom-plus");
    const minusBtn = row.querySelector(".denom-minus");

    plusBtn?.addEventListener("click", () => {
      denomQtys.set(cents, (denomQtys.get(cents) ?? 0) + 1);
      updateCountDisplay();
    });

    minusBtn?.addEventListener("click", () => {
      const current = denomQtys.get(cents) ?? 0;
      if (current > 0) {
        denomQtys.set(cents, current - 1);
        updateCountDisplay();
      }
    });
  });

  denomResetBtn?.addEventListener("click", () => resetDenominations());

  // --- QTY NUMPAD OVERLAY ---
  const qtyOverlay = document.getElementById("qty-numpad-overlay");
  const qtyDisplay = document.getElementById("qty-numpad-display");
  const qtyLabel = document.getElementById("qty-numpad-label");
  const qtyConfirm = document.getElementById("qty-numpad-confirm");
  const qtyCancelBtn = document.getElementById("qty-numpad-cancel");
  const qtyClear = document.getElementById("qty-numpad-clear");
  const qtyBackspace = document.getElementById("qty-numpad-backspace");
  const qtyNumpadBtns = document.querySelectorAll(".qty-numpad-btn");

  let editingCents = 0;
  let qtyInputValue = 0;

  function showQtyNumpad(cents: number, label: string) {
    editingCents = cents;
    qtyInputValue = denomQtys.get(cents) ?? 0;
    if (qtyLabel) qtyLabel.textContent = label;
    if (qtyDisplay) qtyDisplay.textContent = String(qtyInputValue);
    qtyOverlay?.classList.remove("hidden");
  }

  function hideQtyNumpad() {
    qtyOverlay?.classList.add("hidden");
  }

  function updateQtyDisplay() {
    if (qtyDisplay) qtyDisplay.textContent = String(qtyInputValue);
  }

  // Open numpad when clicking on qty
  denomRows.forEach((row) => {
    const cents = parseInt(row.getAttribute("data-cents") ?? "0");
    const qtyEl = row.querySelector(".denom-qty") as HTMLElement | null;
    const labelEl = row.querySelector("span:first-child") as HTMLElement | null;
    if (!qtyEl) return;

    qtyEl.addEventListener("click", () => {
      const label = labelEl?.textContent?.trim() ?? "";
      showQtyNumpad(cents, label);
    });
  });

  // Numpad digit buttons
  qtyNumpadBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      const val = parseInt((btn as HTMLElement).getAttribute("data-val") ?? "0");
      if (qtyInputValue.toString().length >= 4) return;
      qtyInputValue = qtyInputValue * 10 + val;
      updateQtyDisplay();
    });
  });

  // Clear
  qtyClear?.addEventListener("click", () => {
    qtyInputValue = 0;
    updateQtyDisplay();
  });

  // Backspace
  qtyBackspace?.addEventListener("click", () => {
    qtyInputValue = Math.floor(qtyInputValue / 10);
    updateQtyDisplay();
  });

  // Confirm
  qtyConfirm?.addEventListener("click", () => {
    denomQtys.set(editingCents, qtyInputValue);
    updateCountDisplay();
    hideQtyNumpad();
  });

  // Cancel
  qtyCancelBtn?.addEventListener("click", () => {
    hideQtyNumpad();
  });

  // Keyboard support when overlay is visible
  document.addEventListener("keydown", (e) => {
    if (qtyOverlay?.classList.contains("hidden")) return;
    if (e.key >= "0" && e.key <= "9") {
      e.preventDefault();
      if (qtyInputValue.toString().length >= 4) return;
      qtyInputValue = qtyInputValue * 10 + parseInt(e.key);
      updateQtyDisplay();
    } else if (e.key === "Backspace") {
      e.preventDefault();
      qtyInputValue = Math.floor(qtyInputValue / 10);
      updateQtyDisplay();
    } else if (e.key === "Enter") {
      e.preventDefault();
      denomQtys.set(editingCents, qtyInputValue);
      updateCountDisplay();
      hideQtyNumpad();
    } else if (e.key === "Escape") {
      e.preventDefault();
      hideQtyNumpad();
    }
  });

  // --- PRINT TOGGLE ---
  function updatePrintToggle() {
    if (shouldPrint) {
      printToggleUI?.classList.replace("bg-zinc-200", "bg-blue-600");
      if (!printToggleUI?.classList.contains("bg-blue-600")) {
        printToggleUI?.classList.add("bg-blue-600");
        printToggleUI?.classList.remove("bg-zinc-200");
      }
      printToggleKnob?.classList.replace("translate-x-1", "translate-x-6");
      if (!printToggleKnob?.classList.contains("translate-x-6")) {
        printToggleKnob?.classList.add("translate-x-6");
        printToggleKnob?.classList.remove("translate-x-1");
      }
    } else {
      printToggleUI?.classList.replace("bg-blue-600", "bg-zinc-200");
      if (!printToggleUI?.classList.contains("bg-zinc-200")) {
        printToggleUI?.classList.add("bg-zinc-200");
        printToggleUI?.classList.remove("bg-blue-600");
      }
      printToggleKnob?.classList.replace("translate-x-6", "translate-x-1");
      if (!printToggleKnob?.classList.contains("translate-x-1")) {
        printToggleKnob?.classList.add("translate-x-1");
        printToggleKnob?.classList.remove("translate-x-6");
      }
    }
  }

  printToggle?.addEventListener("click", () => {
    shouldPrint = !shouldPrint;
    updatePrintToggle();
  });

  // --- BUILD DENOMINATION DATA ---
  function buildDenominationCount(): { cents: number; label: string; qty: number }[] {
    const result: { cents: number; label: string; qty: number }[] = [];
    denomRows.forEach((row) => {
      const cents = parseInt(row.getAttribute("data-cents") ?? "0");
      const qty = denomQtys.get(cents) ?? 0;
      const labelEl = row.querySelector("span:first-child") as HTMLElement | null;
      const label = labelEl?.textContent?.trim() ?? "";
      if (qty > 0) {
        result.push({ cents, label, qty });
      }
    });
    return result;
  }

  // --- FINALIZE ---
  btnFinalize?.addEventListener("click", async () => {
    if (!btnFinalize) return;
    btnFinalize.disabled = true;
    btnFinalize.textContent = "Wird gespeichert...";

    const countedStr = (getTotalCents() / 100).toFixed(2);
    const report = closureReport.get();
    const diff = new Big(countedStr).minus(
      new Big(report?.expectedCash ?? "0"),
    );
    const denomData = buildDenominationCount();

    try {
      if (shouldPrint && report) {
        printClosureReport(report, countedStr, diff.toFixed(2));
      }

      await finalizeClosure(countedStr, denomData);

      // Show done view
      if (doneDifference) {
        const sign = diff.gte(0) ? "+" : "";
        doneDifference.textContent = `Differenz: ${sign}${diff.toFixed(2)} \u20AC`;
        doneDifference.classList.remove(
          "text-emerald-600",
          "text-red-600",
          "text-zinc-500",
        );
        if (diff.abs().lt(new Big("0.01"))) {
          doneDifference.classList.add("text-zinc-500");
        } else if (diff.gt(0)) {
          doneDifference.classList.add("text-emerald-600");
        } else {
          doneDifference.classList.add("text-red-600");
        }
      }
      showView("done");
    } catch (e) {
      console.error("Closure failed:", e);
      btnFinalize.disabled = false;
      btnFinalize.textContent = "Abschlie\u00dfen";
    }
  });

  // --- DONE ---
  btnOk?.addEventListener("click", closeModal);
</script>
