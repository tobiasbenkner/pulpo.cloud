---
// apps/shop/src/components/ProductCard.astro
import type { Product } from "../types/shop";

interface Props {
  product: Product;
}

const { product } = Astro.props;
const hasImage = product.image && product.image.trim() !== "";

// --- LOGIK: LAGERBESTAND ---
const tracksStock = typeof product.stock === "number";
const isOutOfStock = tracksStock && product.stock === 0;
const isLowStock = tracksStock && product.stock! > 0 && product.stock! <= 5;

// Farben für den "Punkt" (Dot)
let dotColor = "bg-emerald-500";
let stockLabel = "";

if (tracksStock) {
  stockLabel = `${product.stock} Stk.`;
  if (isOutOfStock) {
    dotColor = "bg-zinc-300"; // Grau bei leer
    stockLabel = "Ausverkauft";
  } else if (isLowStock) {
    dotColor = "bg-orange-500 animate-pulse"; // Orange bei wenig
    stockLabel = `${product.stock} verfügbar`;
  }
}
---

<button
  class:list={[
    "product-card", // WICHTIG: Diese Klasse wird für den Filter benötigt
    "group relative flex flex-col w-full bg-white rounded-2xl border transition-all duration-300 overflow-hidden text-left shadow-[0_2px_8px_rgba(0,0,0,0.04)]",
    isOutOfStock
      ? "border-zinc-100 opacity-60 cursor-not-allowed grayscale"
      : "border-zinc-100 hover:border-blue-400/50 hover:shadow-xl hover:-translate-y-1",
  ]}
  data-category={product.category}
  disabled={isOutOfStock}
  onclick={!isOutOfStock
    ? `window.shop.add('${JSON.stringify(product)}')`
    : null}
>
  <!-- 1. BILD BEREICH -->
  <div
    class="relative w-full aspect-[3/2] overflow-hidden bg-zinc-50 border-b border-zinc-50"
  >
    {
      hasImage ? (
        <>
          <img
            src={product.image}
            alt={product.name}
            class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
            loading="lazy"
            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
          />
          <div class="hidden absolute inset-0 items-center justify-center bg-zinc-100 text-zinc-300">
            <svg
              class="w-10 h-10"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
              />
            </svg>
          </div>
        </>
      ) : (
        <div class="w-full h-full flex items-center justify-center text-zinc-300 bg-zinc-50">
          <svg
            class="w-8 h-8"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1.5"
              d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"
            />
          </svg>
        </div>
      )
    }

    <!-- Preis Badge -->
    <div
      class="absolute bottom-2 right-2 bg-zinc-900/90 text-white px-2 py-1 rounded-lg text-xs font-bold shadow-sm backdrop-blur-sm"
    >
      {product.priceGross.toFixed(2)} €
    </div>
  </div>

  <!-- 2. INHALT -->
  <div class="p-3 flex flex-col flex-1">
    <!-- Name -->
    <h3
      class="font-semibold text-zinc-800 text-sm leading-tight line-clamp-2 min-h-[2.5em] mb-2"
      title={product.name}
    >
      {product.name}
    </h3>

    <!-- Footer -->
    <div class="mt-auto flex items-center justify-between">
      {
        tracksStock ? (
          <div class="flex items-center gap-2">
            <span
              class={`block w-2 h-2 rounded-full ${dotColor} ring-2 ring-white`}
            />
            <span
              class={`text-[10px] font-medium uppercase tracking-wide ${isOutOfStock ? "text-zinc-400" : "text-zinc-500"}`}
            >
              {stockLabel}
            </span>
          </div>
        ) : (
          <span class="text-[10px] text-zinc-400 font-medium">Verfügbar</span>
        )
      }

      {
        !isOutOfStock && (
          <svg
            class="w-4 h-4 text-zinc-300 group-hover:text-blue-500 transition-colors transform group-hover:translate-x-0.5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5l7 7-7 7"
            />
          </svg>
        )
      }
    </div>
  </div>
</button>
