---
// apps/shop/src/components/DiscountModal.astro
---

<div
  id="discount-modal"
  class="fixed inset-0 z-[70] hidden"
  role="dialog"
  aria-modal="true"
>
  <!-- Backdrop -->
  <div
    class="fixed inset-0 bg-zinc-900/60 backdrop-blur-sm transition-opacity opacity-0"
    id="disc-backdrop"
  >
  </div>

  <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-4">
      <!-- Modal Panel -->
      <div
        class="relative transform overflow-hidden rounded-3xl bg-white text-left shadow-2xl transition-all w-full max-w-sm opacity-0 scale-95"
        id="disc-panel"
      >
        <!-- Close Button -->
        <button
          id="disc-close-x"
          class="absolute right-4 top-4 p-2 bg-zinc-100 rounded-full text-zinc-400 hover:text-zinc-600 z-10"
        >
          <svg
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M6 18L18 6M6 6l12 12"></path></svg
          >
        </button>

        <div class="p-6 flex flex-col h-full">
          <h3 class="text-xl font-bold text-center text-zinc-900 mb-6">
            Rabatt anwenden
          </h3>

          <!-- 1. TOGGLE (Prozent / Euro) -->
          <div class="flex bg-zinc-100 p-1.5 rounded-xl mb-4">
            <button
              id="tab-percent"
              class="flex-1 py-2.5 rounded-lg font-bold text-sm bg-white shadow-sm text-zinc-900 transition-all"
            >
              Prozent (%)
            </button>
            <button
              id="tab-fixed"
              class="flex-1 py-2.5 rounded-lg font-bold text-sm text-zinc-500 hover:text-zinc-700 transition-all"
            >
              Euro (€)
            </button>
          </div>

          <!-- 2. DISPLAY -->
          <div
            class="bg-zinc-900 rounded-2xl p-4 mb-4 text-right shadow-inner h-20 flex flex-col justify-center"
          >
            <span
              class="text-zinc-400 text-[10px] font-medium uppercase tracking-wider mb-0.5"
              >Wert</span
            >
            <div class="flex justify-end items-baseline gap-1 text-white">
              <span
                id="disc-val-display"
                class="text-4xl font-mono tracking-tight font-bold">0</span
              >
              <span
                id="disc-unit-display"
                class="text-xl font-bold text-zinc-500">%</span
              >
            </div>
          </div>

          <!-- 3. SCHNELLWAHL (Wird per JS angepasst) -->
          <div class="grid grid-cols-4 gap-2 mb-4">
            {
              [5, 10, 15, 20].map((val) => (
                <button
                  class="quick-disc-btn py-2 bg-blue-50 text-blue-600 border border-blue-100 rounded-lg font-bold text-sm hover:bg-blue-100 transition-colors active:scale-95"
                  data-val={val}
                >
                  {val}%
                </button>
              ))
            }
          </div>

          <!-- 4. NUMPAD -->
          <div class="grid grid-cols-3 gap-3 mb-6 select-none">
            {
              [1, 2, 3, 4, 5, 6, 7, 8, 9].map((num) => (
                <button
                  class="disc-num-btn bg-white border border-zinc-200 text-2xl font-medium py-3 rounded-xl hover:bg-zinc-50 active:scale-95 shadow-sm text-zinc-700 active:bg-zinc-100"
                  data-num={num}
                >
                  {num}
                </button>
              ))
            }
            <button
              class="disc-num-btn bg-white border border-zinc-200 text-2xl font-medium py-3 rounded-xl hover:bg-zinc-50 active:scale-95 shadow-sm text-zinc-700"
              data-num=".">.</button
            >
            <button
              class="disc-num-btn bg-white border border-zinc-200 text-2xl font-medium py-3 rounded-xl hover:bg-zinc-50 active:scale-95 shadow-sm text-zinc-700"
              data-num="0">0</button
            >
            <button
              id="disc-clear"
              class="bg-red-50 text-red-600 text-xl font-bold py-3 rounded-xl hover:bg-red-100 active:scale-95 border border-red-100"
              >C</button
            >
          </div>

          <!-- 5. ACTIONS -->
          <div class="flex gap-3">
            <button
              id="btn-remove-discount"
              class="flex-1 py-3.5 text-red-500 font-bold text-sm border border-red-100 rounded-xl hover:bg-red-50 active:scale-95 transition-colors"
            >
              Entfernen
            </button>
            <button
              id="btn-confirm-discount"
              class="flex-[2] py-3.5 bg-zinc-900 text-white font-bold text-lg rounded-xl shadow-lg hover:bg-black active:scale-95 transition-all"
            >
              Speichern
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  import {
    isDiscountModalOpen,
    applyDiscount,
    removeDiscount,
    cartItems, // WICHTIG: Importieren um existierenden Rabatt zu laden
  } from "../stores/cartStore";

  // Elements
  const modal = document.getElementById("discount-modal")!;
  const backdrop = document.getElementById("disc-backdrop")!;
  const panel = document.getElementById("disc-panel")!;
  const closeBtn = document.getElementById("disc-close-x")!;

  const tabPercent = document.getElementById("tab-percent")!;
  const tabFixed = document.getElementById("tab-fixed")!;

  const displayVal = document.getElementById("disc-val-display")!;
  const displayUnit = document.getElementById("disc-unit-display")!;

  const numBtns = document.querySelectorAll(".disc-num-btn");
  const quickBtns = document.querySelectorAll(".quick-disc-btn");
  const clearBtn = document.getElementById("disc-clear")!;

  const confirmBtn = document.getElementById("btn-confirm-discount")!;
  const removeBtn = document.getElementById("btn-remove-discount")!;

  // State
  let currentType: "percent" | "fixed" = "percent";
  let inputBuffer = "0";

  // --- LOGIC: UPDATE UI ---
  function setTab(type: "percent" | "fixed") {
    currentType = type;

    // Style Update
    if (type === "percent") {
      tabPercent.className =
        "flex-1 py-2.5 rounded-lg font-bold text-sm bg-white shadow-sm text-zinc-900 transition-all";
      tabFixed.className =
        "flex-1 py-2.5 rounded-lg font-bold text-sm text-zinc-500 hover:text-zinc-700 transition-all";
      displayUnit.innerText = "%";
    } else {
      tabFixed.className =
        "flex-1 py-2.5 rounded-lg font-bold text-sm bg-white shadow-sm text-zinc-900 transition-all";
      tabPercent.className =
        "flex-1 py-2.5 rounded-lg font-bold text-sm text-zinc-500 hover:text-zinc-700 transition-all";
      displayUnit.innerText = "€";
    }

    // Quick Buttons Beschriftung anpassen
    quickBtns.forEach((btn) => {
      const val = btn.getAttribute("data-val");
      btn.textContent = type === "percent" ? `${val}%` : `${val}€`;
    });

    updateDisplay();
  }

  function updateDisplay() {
    displayVal.innerText = inputBuffer;
  }

  // --- LOGIC: VISIBILITY & LOADING ---
  isDiscountModalOpen.subscribe((state) => {
    if (state.itemId) {
      // 1. Existierenden Rabatt laden (falls vorhanden)
      const currentItems = cartItems.get();
      const item = currentItems[state.itemId];

      if (item && item.discount) {
        currentType = item.discount.type;
        inputBuffer = item.discount.value.toString();
      } else {
        // Standardwerte (wenn noch kein Rabatt)
        currentType = "percent";
        inputBuffer = "0";
      }

      // UI setzen
      setTab(currentType);

      // Animation
      modal.classList.remove("hidden");
      setTimeout(() => {
        backdrop.classList.remove("opacity-0");
        panel.classList.remove("opacity-0", "scale-95");
      }, 10);
    } else {
      backdrop.classList.add("opacity-0");
      panel.classList.add("opacity-0", "scale-95");
      setTimeout(() => modal.classList.add("hidden"), 300);
    }
  });

  closeBtn.addEventListener("click", () =>
    isDiscountModalOpen.set({ itemId: null })
  );

  // --- LOGIC: EVENTS ---

  // Tabs
  tabPercent.addEventListener("click", () => setTab("percent"));
  tabFixed.addEventListener("click", () => setTab("fixed"));

  // Numpad
  numBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      const char = btn.getAttribute("data-num")!;

      if (char === ".") {
        if (inputBuffer.includes(".")) return;
        inputBuffer += ".";
      } else {
        if (inputBuffer === "0") inputBuffer = char;
        else inputBuffer += char;
      }

      // Limit decimals for Euro
      if (currentType === "fixed" && inputBuffer.includes(".")) {
        const parts = inputBuffer.split(".");
        if (parts[1].length > 2) return;
      }
      // Limit Percentage
      if (currentType === "percent" && parseFloat(inputBuffer) > 100) {
        inputBuffer = "100";
      }

      updateDisplay();
    });
  });

  // Clear
  clearBtn.addEventListener("click", () => {
    inputBuffer = "0";
    updateDisplay();
  });

  // Quick Buttons (BEHOBEN: Ändert nicht mehr den Modus!)
  quickBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      inputBuffer = btn.getAttribute("data-val")!;
      // KEIN setTab(...) Aufruf hier!
      updateDisplay();
    });
  });

  // Actions
  confirmBtn.addEventListener("click", () => {
    const val = parseFloat(inputBuffer);
    const itemId = isDiscountModalOpen.get().itemId;

    if (itemId && !isNaN(val)) {
      applyDiscount(itemId, currentType, val);
      isDiscountModalOpen.set({ itemId: null });
    }
  });

  removeBtn.addEventListener("click", () => {
    const itemId = isDiscountModalOpen.get().itemId;
    if (itemId) {
      removeDiscount(itemId);
      isDiscountModalOpen.set({ itemId: null });
    }
  });
</script>
