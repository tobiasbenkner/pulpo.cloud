---
// apps/shop/src/components/Cart.astro
---

<div class="flex-1 flex flex-col h-full bg-white border-l border-zinc-200">
  <!-- Header -->
  <div class="p-6 border-b border-zinc-100 bg-white">
    <h2 class="text-2xl font-bold text-zinc-800 flex items-center gap-2">
      ðŸ›’ Warenkorb
      <span
        id="cart-count-badge"
        class="text-sm bg-indigo-100 text-indigo-600 px-2.5 py-1 rounded-full font-bold"
        >0</span
      >
    </h2>
  </div>

  <!-- Items List (Scrollable) -->
  <div
    id="cart-list-container"
    class="flex-1 overflow-y-auto p-4 space-y-3 bg-zinc-50 relative"
  >
    <!-- Items werden hier per JS injiziert -->
    <div
      class="absolute inset-0 flex items-center justify-center text-zinc-400 pointer-events-none"
    >
      <span class="text-sm">Lade Warenkorb...</span>
    </div>
  </div>

  <!-- Footer (Totals & Pay) -->
  <div
    class="p-6 bg-white border-t border-zinc-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-10"
  >
    <div class="space-y-2 mb-4 text-sm">
      <div class="flex justify-between text-zinc-500">
        <span>Netto</span>
        <span id="display-net" class="font-mono">0.00 â‚¬</span>
      </div>
      <div class="flex justify-between text-zinc-500">
        <span>Steuer</span>
        <span id="display-tax" class="font-mono">0.00 â‚¬</span>
      </div>
      <div
        class="flex justify-between text-xl font-bold text-zinc-900 pt-3 border-t border-zinc-100 mt-2"
      >
        <span>Total</span>
        <span id="display-gross">0.00 â‚¬</span>
      </div>
    </div>

    <button
      id="btn-checkout"
      class="w-full bg-zinc-900 hover:bg-black text-white font-bold py-4 rounded-xl text-lg shadow-lg shadow-zinc-200 transition-all active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed"
      disabled
    >
      Bezahlen
    </button>
  </div>
</div>

<script>
  import {
    cartItems,
    cartTotals,
    removeFromCart,
    isPaymentModalOpen, // War vorher 'isCheckoutOpen', muss konsistent sein
  } from "../stores/cartStore";

  // 1. Elemente sicher selektieren
  const listEl = document.getElementById("cart-list-container");
  const countEl = document.getElementById("cart-count-badge");
  const grossEl = document.getElementById("display-gross");
  const netEl = document.getElementById("display-net");
  const taxEl = document.getElementById("display-tax");

  // Type Casting fÃ¼r den Button, damit TS weiÃŸ, dass er 'disabled' haben kann
  const checkoutBtn = document.getElementById(
    "btn-checkout"
  ) as HTMLButtonElement | null;

  // Sicherheits-Check: Wenn Elemente fehlen (warum auch immer), Skript abbrechen
  if (!listEl || !countEl || !grossEl || !netEl || !taxEl || !checkoutBtn) {
    console.error("Cart Elements not found in DOM");
    throw new Error("Cart DOM elements missing");
  }

  // 2. Event Delegation fÃ¼r Delete-Buttons (Viel performanter!)
  listEl.addEventListener("click", (e) => {
    const target = e.target as HTMLElement;
    // Suche nach dem nÃ¤chsten Button mit data-action="remove"
    const btn = target.closest('button[data-action="remove"]');

    if (btn) {
      const id = btn.getAttribute("data-id");
      if (id) removeFromCart(id);
    }
  });

  // 3. Checkout Button Listener
  checkoutBtn.addEventListener("click", () => {
    isPaymentModalOpen.set(true);
  });

  // 4. Subscription: Totals & Button State
  cartTotals.subscribe((totals) => {
    grossEl.innerText = `${totals.gross} â‚¬`;
    netEl.innerText = `${totals.net} â‚¬`;
    taxEl.innerText = `${totals.tax} â‚¬`;
    countEl.innerText = totals.count.toString();

    // Button aktivieren/deaktivieren
    if (totals.count > 0) {
      checkoutBtn.disabled = false;
      checkoutBtn.classList.remove("opacity-50", "cursor-not-allowed");
    } else {
      checkoutBtn.disabled = true;
      checkoutBtn.classList.add("opacity-50", "cursor-not-allowed");
    }
  });

  // 5. Subscription: Items rendern
  cartItems.subscribe((items) => {
    listEl.innerHTML = "";
    const entries = Object.entries(items);

    if (entries.length === 0) {
      listEl.innerHTML = `
        <div class="h-full flex flex-col items-center justify-center text-zinc-300 select-none">
            <svg class="w-12 h-12 mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <span class="text-sm font-medium">Warenkorb leer</span>
        </div>`;
      return;
    }

    entries.forEach(([id, item]) => {
      // Rabatt Berechnung fÃ¼r Anzeige
      const originalTotal = item.priceGross * item.quantity;
      let finalTotal = originalTotal;
      let isDiscounted = false;

      if (item.discount) {
        isDiscounted = true;
        if (item.discount.type === "percent") {
          finalTotal = originalTotal * (1 - item.discount.value / 100);
        } else {
          finalTotal = Math.max(0, originalTotal - item.discount.value);
        }
      }

      const el = document.createElement("div");
      // Animation Klassen hinzufÃ¼gen
      el.className =
        "flex items-center justify-between bg-white p-3 rounded-xl shadow-sm border border-zinc-100 group animate-in fade-in slide-in-from-bottom-2 duration-300";

      el.innerHTML = `
        <div class="flex flex-col min-w-0 pr-3">
            <span class="font-bold text-zinc-800 truncate" title="${item.name}">${item.name}</span>
            <span class="text-xs text-zinc-400 font-mono mt-0.5">
                ${item.quantity} x ${item.priceGross.toFixed(2)} â‚¬
                ${isDiscounted ? `<span class="text-orange-500 ml-1">(Rabatt aktiv)</span>` : ""}
            </span>
        </div>
        
        <div class="flex items-center gap-3">
            <div class="flex flex-col items-end">
                ${
                  isDiscounted
                    ? `<span class="text-[10px] text-zinc-400 line-through decoration-zinc-300">${originalTotal.toFixed(2)} â‚¬</span>`
                    : ""
                }
                <span class="font-bold ${isDiscounted ? "text-orange-600" : "text-zinc-900"} tabular-nums">
                    ${finalTotal.toFixed(2)}â‚¬
                </span>
            </div>
            
            <button 
                class="text-zinc-300 hover:text-red-500 p-2 hover:bg-red-50 rounded-lg transition-colors active:scale-90" 
                data-action="remove" 
                data-id="${id}"
                title="Entfernen"
            >
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
        </div>
      `;
      listEl.appendChild(el);
    });
  });
</script>
