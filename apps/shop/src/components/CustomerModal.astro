---
// apps/shop/src/components/CustomerModal.astro
---

<div id="customer-modal" class="fixed inset-0 z-[60] hidden" role="dialog" aria-modal="true">
    <!-- Backdrop (etwas dunkler, da es über dem Checkout liegen könnte) -->
    <div class="fixed inset-0 bg-zinc-900/60 backdrop-blur-md transition-opacity opacity-0" id="cust-backdrop"></div>

    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            
            <div class="relative transform overflow-hidden rounded-3xl bg-white text-left shadow-2xl transition-all w-full max-w-2xl opacity-0 scale-95" id="cust-panel">
                
                <!-- Header -->
                <div class="flex justify-between items-center px-6 py-4 border-b border-zinc-100 bg-zinc-50">
                    <h3 class="text-lg font-bold text-zinc-900">Seleccionar cliente</h3>
                    <button id="cust-close-btn" class="p-2 bg-white rounded-full text-zinc-400 hover:text-zinc-600 shadow-sm">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>

                <div class="p-6">
                    <!-- Suche -->
                    <div class="relative mb-6">
                        <input type="text" placeholder="Buscar por nombre o NIF..." class="w-full pl-10 pr-4 py-3 bg-white border border-zinc-200 rounded-xl focus:ring-2 focus:ring-zinc-900 focus:border-zinc-900 transition-all" />
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>

                    <!-- Dummy Liste -->
                    <div class="space-y-2 mb-6 max-h-60 overflow-y-auto pr-2" id="cust-list">
                        <!-- JS inject -->
                    </div>

                    <!-- Neuer Kunde Form (Toggle) -->
                    <details class="group bg-zinc-50 rounded-xl border border-zinc-200">
                        <summary class="list-none flex justify-between items-center p-4 cursor-pointer font-bold text-zinc-700">
                            <span>+ Crear nuevo cliente</span>
                            <svg class="w-5 h-5 transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </summary>
                        <div class="p-4 pt-0 grid grid-cols-2 gap-3">
                            <input id="new-name" type="text" placeholder="Nombre de la empresa / Nombre" class="col-span-2 p-3 rounded-lg border border-zinc-200" />
                            <input id="new-nif" type="text" placeholder="NIF / CIF" class="p-3 rounded-lg border border-zinc-200" />
                            <input id="new-zip" type="text" placeholder="Código postal" class="p-3 rounded-lg border border-zinc-200" />
                            <input id="new-address" type="text" placeholder="Dirección" class="col-span-2 p-3 rounded-lg border border-zinc-200" />
                            <input id="new-city" type="text" placeholder="Ciudad" class="col-span-2 p-3 rounded-lg border border-zinc-200" />
                            <button id="btn-create-cust" class="col-span-2 bg-zinc-900 text-white py-3 rounded-lg font-bold mt-2">Crear y seleccionar cliente</button>
                        </div>
                    </details>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    import { isCustomerModalOpen, setCustomer } from '../stores/cartStore';
    import type { Customer } from '../types/shop';

    const modal = document.getElementById('customer-modal')!;
    const backdrop = document.getElementById('cust-backdrop')!;
    const panel = document.getElementById('cust-panel')!;
    const closeBtn = document.getElementById('cust-close-btn')!;
    const listEl = document.getElementById('cust-list')!;
    const createBtn = document.getElementById('btn-create-cust') as HTMLButtonElement;

    // Dummy Daten
    const customers: Customer[] = [
        { id: 'c1', name: 'Hotel Riu Palace', nif: 'B35123456', address: 'Av. Gran Canaria 1', zip: '35100', city: 'Maspalomas' },
        { id: 'c2', name: 'Restaurante El Mar', nif: 'B35987654', address: 'Paseo Maritimo 20', zip: '35100', city: 'Meloneras' },
    ];

    isCustomerModalOpen.subscribe(isOpen => {
        if (isOpen) {
            renderList();
            modal.classList.remove('hidden');
            setTimeout(() => {
                backdrop.classList.remove('opacity-0');
                panel.classList.remove('opacity-0', 'scale-95');
            }, 10);
        } else {
            backdrop.classList.add('opacity-0');
            panel.classList.add('opacity-0', 'scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
    });

    closeBtn.addEventListener('click', () => isCustomerModalOpen.set(false));

    function renderList() {
        listEl.innerHTML = '';
        customers.forEach(cust => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-3 bg-white border border-zinc-100 rounded-lg hover:border-zinc-300 cursor-pointer transition-colors';
            div.innerHTML = `
                <div>
                    <div class="font-bold text-zinc-900">${cust.name}</div>
                    <div class="text-xs text-zinc-500">NIF: ${cust.nif} • ${cust.city}</div>
                </div>
                <div class="text-zinc-300">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </div>
            `;
            div.addEventListener('click', () => {
                setCustomer(cust); // Store updaten
            });
            listEl.appendChild(div);
        });
    }

    createBtn.addEventListener('click', () => {
        // Simple Create Logic
        const newCust: Customer = {
            id: `new-${Date.now()}`,
            name: (document.getElementById('new-name') as HTMLInputElement).value,
            nif: (document.getElementById('new-nif') as HTMLInputElement).value,
            address: (document.getElementById('new-address') as HTMLInputElement).value,
            zip: (document.getElementById('new-zip') as HTMLInputElement).value,
            city: (document.getElementById('new-city') as HTMLInputElement).value,
        };
        setCustomer(newCust);
    });
</script>