---
// apps/shop/src/components/QuantityModal.astro
---

<div
  id="quantity-modal"
  class="fixed inset-0 z-80 hidden"
  role="dialog"
  aria-modal="true"
>
  <!-- Backdrop -->
  <div
    class="fixed inset-0 bg-zinc-900/60 backdrop-blur-sm transition-opacity opacity-0"
    id="qty-backdrop"
  >
  </div>

  <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-4">
      <div
        class="relative transform overflow-hidden rounded-3xl bg-white text-left shadow-2xl transition-all w-full max-w-xs opacity-0 scale-95"
        id="qty-panel"
      >
        <button
          id="qty-close-x"
          class="absolute right-4 top-4 p-2 bg-zinc-100 rounded-full text-zinc-400 hover:text-zinc-600 z-10"
        >
          <svg
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M6 18L18 6M6 6l12 12"></path></svg
          >
        </button>

        <div class="p-6 flex flex-col h-full">
          <h3 class="text-xl font-bold text-center text-zinc-900 mb-6">
            Menge ändern
          </h3>

          <!-- Display -->
          <div
            class="bg-zinc-900 rounded-2xl p-4 mb-4 text-center shadow-inner h-20 flex flex-col justify-center"
          >
            <span
              class="text-zinc-400 text-[10px] font-medium uppercase tracking-wider mb-0.5"
              >Anzahl</span
            >
            <div
              class="text-5xl font-mono tracking-tight font-bold text-white"
              id="qty-display"
            >
              1
            </div>
          </div>

          <!-- Numpad -->
          <div class="grid grid-cols-3 gap-3 mb-6 select-none">
            {
              [1, 2, 3, 4, 5, 6, 7, 8, 9].map((num) => (
                <button
                  class="qty-num-btn bg-white border border-zinc-200 text-2xl font-medium py-3 rounded-xl hover:bg-zinc-50 active:scale-95 shadow-sm text-zinc-700 active:bg-zinc-100"
                  data-num={num}
                >
                  {num}
                </button>
              ))
            }
            <!-- Leerer Platzhalter links -->
            <div class="col-span-1"></div>
            <button
              class="qty-num-btn bg-white border border-zinc-200 text-2xl font-medium py-3 rounded-xl hover:bg-zinc-50 active:scale-95 shadow-sm text-zinc-700"
              data-num="0">0</button
            >
            <button
              id="qty-clear"
              class="bg-red-50 text-red-600 text-xl font-bold py-3 rounded-xl hover:bg-red-100 active:scale-95 border border-red-100"
              >C</button
            >
          </div>

          <!-- Actions -->
          <div class="flex gap-3">
            <button
              id="btn-remove-item"
              class="flex-1 py-3.5 text-red-500 font-bold text-sm border border-red-100 rounded-xl hover:bg-red-50 active:scale-95 transition-colors"
            >
              Löschen
            </button>
            <button
              id="btn-confirm-qty"
              class="flex-[2] py-3.5 bg-zinc-900 text-white font-bold text-lg rounded-xl shadow-lg hover:bg-black active:scale-95 transition-all"
            >
              Bestätigen
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  import {
    isQuantityModalOpen,
    setItemQuantity,
    removeFromCart,
    cartItems,
  } from "../stores/cartStore";

  const modal = document.getElementById("quantity-modal");
  const backdrop = document.getElementById("qty-backdrop");
  const panel = document.getElementById("qty-panel");
  const closeBtn = document.getElementById("qty-close-x");
  const displayEl = document.getElementById("qty-display");
  const numBtns = document.querySelectorAll(".qty-num-btn");
  const clearBtn = document.getElementById("qty-clear");
  const confirmBtn = document.getElementById("btn-confirm-qty");
  const removeItemBtn = document.getElementById("btn-remove-item"); // NEU: Löschen Button

  let inputBuffer = "";
  let currentItemId: string | null = null;

  // --- LOGIC ---
  function updateDisplay() {
    if (displayEl) {
      displayEl.innerText = inputBuffer === "" ? "0" : inputBuffer;
    }
  }

  isQuantityModalOpen.subscribe((state) => {
    if (state.itemId) {
      currentItemId = state.itemId;

      // Beim Öffnen: Aktuelle Menge als Startwert setzen, wenn vorhanden
      const currentItem = cartItems.get()[state.itemId];
      inputBuffer = currentItem ? currentItem.quantity.toString() : "1"; // Starte mit "1" falls neu oder nicht gefunden

      updateDisplay();

      modal?.classList.remove("hidden");
      setTimeout(() => {
        backdrop?.classList.remove("opacity-0");
        panel?.classList.remove("opacity-0", "scale-95");
      }, 10);
    } else {
      backdrop?.classList.add("opacity-0");
      panel?.classList.add("opacity-0", "scale-95");
      setTimeout(() => modal?.classList.add("hidden"), 300);
    }
  });

  closeBtn?.addEventListener("click", () =>
    isQuantityModalOpen.set({ itemId: null })
  );

  // Numpad Events
  numBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      const char = btn.getAttribute("data-num");
      if (!char) return; // Sicherheits-Check

      // Leere den Buffer, wenn die erste Ziffer eingegeben wird und es nicht das Komma ist
      // ODER wenn der Buffer nur "0" war
      if (inputBuffer === "" || inputBuffer === "0") {
        inputBuffer = char;
      } else if (inputBuffer.length < 3) {
        // Max 999
        inputBuffer += char;
      }

      updateDisplay();
    });
  });

  clearBtn?.addEventListener("click", () => {
    inputBuffer = "";
    updateDisplay();
  });

  confirmBtn?.addEventListener("click", () => {
    if (currentItemId) {
      const qty = parseInt(inputBuffer === "" ? "0" : inputBuffer); // Wenn leer, als 0 interpretieren (entfernt)
      setItemQuantity(currentItemId, qty);
      isQuantityModalOpen.set({ itemId: null });
    }
  });

  // NEU: Event Listener für den Löschen Button
  removeItemBtn?.addEventListener("click", () => {
    if (currentItemId) {
      removeFromCart(currentItemId); // Item vollständig entfernen
      isQuantityModalOpen.set({ itemId: null }); // Modal schließen
    }
  });
</script>
