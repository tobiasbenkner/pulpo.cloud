---
import Layout from "../layouts/Layout.astro";
import ProductCard from "../components/ProductCard.astro";
import CartSidebar from "../components/CartSidebar.astro";
import CheckoutModal from "../components/CheckoutModal.astro";
import CustomAmountModal from "../components/CustomAmountModal.astro";
import CustomerModal from "../components/CustomerModal.astro";
import DiscountModal from "../components/DiscountModal.astro";
import QuantityModal from "../components/QuantityModal.astro";
import AuthGuard from "@pulpo/auth/components/AuthGuard.svelte";
import { categories, products } from "../data/data";
---

<Layout title="POS Pulpo">
  <AuthGuard client:only="svelte" />

  <div id="pos-content" class="grid grid-cols-[1fr_340px] h-full hidden">
    <!-- Linker Bereich -->
    <main class="h-full flex flex-col relative overflow-hidden bg-zinc-50">
      <!-- HEADER -->
      <div
        class="flex-none flex items-start gap-4 px-4 py-3 bg-zinc-50 z-10 shadow-sm border-b border-zinc-200 min-h-[64px]"
      >
        <!-- LOGO -->
        <div
          class="flex-none flex items-center justify-center bg-zinc-900 text-white w-9 h-9 rounded-lg shadow-md cursor-pointer hover:bg-zinc-800 transition-colors mt-0.5"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg
          >
        </div>

        <!-- KATEGORIEN -->
        <nav class="flex-1 flex flex-wrap gap-2">
          {
            categories.map((cat, i) => (
              <button
                class={`category-btn px-4 py-2 rounded-lg text-xs font-bold transition-all duration-200 active:scale-95 whitespace-nowrap border ${
                  i === 0
                    ? "bg-zinc-900 text-white border-zinc-900 shadow-md"
                    : "bg-white text-zinc-500 border-zinc-200 hover:border-zinc-400 hover:text-zinc-900 hover:bg-zinc-50"
                }`}
                data-cat={cat}
              >
                {cat}
              </button>
            ))
          }
        </nav>
      </div>

      <!-- PRODUKT-BEREICH -->
      <div class="flex-1 overflow-y-auto px-4 py-4 scroll-smooth">
        <div
          class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 pb-20"
        >
          <!-- BUTTON: FREIER BETRAG -->
          <button
            id="btn-open-custom"
            class="group flex flex-col h-full bg-zinc-50 rounded-2xl border-2 border-dashed border-zinc-300 overflow-hidden active:scale-95 active:bg-zinc-100 active:border-zinc-400 text-left hover:border-zinc-400 hover:bg-zinc-100 transition-all min-h-[140px]"
          >
            <div
              class="flex-1 flex flex-col items-center justify-center p-4 text-zinc-400 group-hover:text-zinc-600"
            >
              <div
                class="w-12 h-12 rounded-full bg-zinc-200 group-hover:bg-zinc-300 flex items-center justify-center mb-2 transition-colors"
              >
                <svg
                  class="w-6 h-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
              </div>
              <span
                class="font-bold text-xs uppercase tracking-wide text-center"
                >Freier<br />Betrag</span
              >
            </div>
          </button>

          <!-- PRODUKTE -->
          {products.map((product) => <ProductCard product={product} />)}
        </div>
      </div>
    </main>

    <!-- Rechter Bereich (Sidebar) -->
    <CartSidebar />
  </div>

  <!-- Modals -->
  <CheckoutModal />
  <CustomAmountModal />
  <CustomerModal />
  <DiscountModal />
  <QuantityModal />
</Layout>

<script>
  import { authStore } from "@pulpo/auth";

  authStore.subscribe((state) => {
    if (!state.loading && state.isAuthenticated) {
      document.getElementById("pos-content")?.classList.remove("hidden");
    }
  });
</script>

<script>
  import {
    addToCart,
    removeFromCart,
    isCustomAmountOpen,
  } from "../stores/cartStore";

  // Shop API für ProductCard onclick
  // @ts-ignore
  window.shop = {
    add: (jsonStr: string) => {
      const product = JSON.parse(jsonStr);
      addToCart(product);
    },
    remove: (id: string) => {
      removeFromCart(id);
    },
  };

  // 1. Custom Amount
  document.getElementById("btn-open-custom")?.addEventListener("click", () => {
    isCustomAmountOpen.set(true);
  });

  // 2. Filter Logic
  const buttons = document.querySelectorAll(".category-btn");
  const cards = document.querySelectorAll(".product-card");

  // DEFINITION DER FARBEN (Schwarz/Weiß Theme)

  // Wenn Aktiv: Schwarz mit weißem Text
  const activeClasses = [
    "bg-zinc-900",
    "text-white",
    "border-zinc-900",
    "shadow-md",
  ];

  // Wenn Inaktiv: Weiß mit grauem Text, beim Hovern wird Rahmen dunkler, aber NICHT schwarz gefüllt
  const inactiveClasses = [
    "bg-white",
    "text-zinc-500",
    "border-zinc-200",
    "hover:border-zinc-400",
    "hover:text-zinc-900",
    "hover:bg-zinc-50",
  ];

  buttons.forEach((btn) => {
    btn.addEventListener("click", () => {
      // A) Reset aller Buttons
      buttons.forEach((b) => {
        b.classList.remove(...activeClasses);
        b.classList.add(...inactiveClasses);
      });

      // B) Aktiven Button setzen
      btn.classList.remove(...inactiveClasses);
      btn.classList.add(...activeClasses);

      // C) Filtern
      const selectedCat = (btn as HTMLElement).dataset.cat;
      cards.forEach((card) => {
        const cardCat = (card as HTMLElement).dataset.category;

        if (selectedCat === "Alle" || cardCat === selectedCat) {
          card.classList.remove("hidden");
          card.classList.add("flex");
        } else {
          card.classList.remove("flex");
          card.classList.add("hidden");
        }
      });
    });
  });
</script>
