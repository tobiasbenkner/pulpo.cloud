---
import Layout from "@/layouts/Layout.astro";
import { getBlogCategories, getLanguages, getPosts } from "@/lib/cms";
import {
  defaultLang,
  languages,
  resolveTranslations,
  type Language,
} from "@/lib/i18n";
import BlogDetail from "@/views/blog/BlogDetail.astro";
import BlogList from "@/views/blog/BlogList.astro";
import type { BlogPost, BlogPostCategory } from "@pulpo/cms";

type PathProps = {
  type: "category" | "post";
  lang: string;
  category: BlogPostCategory;
  post?: BlogPost;
};

export async function getStaticPaths() {
  // TODO: Erweiterung routeSlugs f√ºr routing

  const paths: {
    params: { blog: string };
    props: PathProps;
  }[] = [];

  const languagesss = await getLanguages();

  const categories = await getBlogCategories();
  for (const category of categories) {
    const posts = await getPosts(category.id);

    for (const lang of languages) {
      const isDefaultLang = lang === defaultLang;
      const categorySlug = resolveTranslations(category.slug, lang) as string;

      const urlPrefix = isDefaultLang
        ? `/blog/${categorySlug}`
        : `/${lang}/blog/${categorySlug}`;

      for (const post of posts) {
        const postSlug = resolveTranslations(post.slug, lang) as string;

        paths.push({
          params: {
            blog: `${urlPrefix}/${postSlug}`,
          },
          props: {
            type: "post",
            lang: lang,
            post: post,
            category: category,
          },
        });
      }
    }

    for (const lang of languages) {
      const isDefaultLang = lang === defaultLang;
      const urlPrefix = isDefaultLang ? "/blog" : `/${lang}/blog`;
      const categorySlug = resolveTranslations(category.slug, lang) as string;

      paths.push({
        params: {
          blog: `${urlPrefix}/${categorySlug}`,
        },
        props: {
          type: "category",
          lang: lang,
          category: category,
        },
      });
    }
  }

  return paths;
}

const { lang, type, category, post } = Astro.props;

// SEO
let title = "";
let description = "";
let ogImage = undefined;

if (type === "post" && post) {
  const t = post.translations[0];
  title = t ? t.title : "Blog";
  description = t ? t.excerpt : "";
  // ogImage = post.image?.id;
} else {
  title = `News: ${category.title}`;
  description = `Aktuelle Nachrichten aus dem Bereich ${category.title}`;
  // TODO: Photo von Post Category
}
---

<Layout
  title={title}
  description={description}
  lang={lang as Language}
  routeKey={""}
  ogImage={ogImage}
>
  {
    type === "post" && !!post && (
      <BlogDetail lang={lang as Language} post={post} category={category} />
    )
  }

  {
    type === "category" && (
      <BlogList lang={lang} category={category} title={title} />
    )
  }
</Layout>
