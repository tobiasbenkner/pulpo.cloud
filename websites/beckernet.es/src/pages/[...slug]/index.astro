---
import { languages, defaultLang } from "@/lib/i18n";
import { routeSlugs, getView } from "@/lib/registry";
import Layout from "@/layouts/Layout.astro";
import { getPosts, getPost } from "@/lib/cms";

export async function getStaticPaths() {
  const paths: any[] = [];
  const allRouteKeys = Object.keys(routeSlugs).concat("home");

  // 1. Statische Seiten generieren
  allRouteKeys.forEach((routeKey) => {
    // wird in anderer loop erzeugt
    if (routeKey === "blog_detail") return;

    languages.forEach((lang) => {
      let slugParam: string | undefined;
      const isDefaultLang = lang === defaultLang;

      if (routeKey === "home") {
        slugParam = isDefaultLang ? undefined : lang;
      } else {
        const slugs = routeSlugs[routeKey];
        if (!slugs) return;
        const pageSlug = slugs[lang];
        if (pageSlug) {
          slugParam = isDefaultLang ? pageSlug : `${lang}/${pageSlug}`;
        }
      }

      paths.push({
        params: { slug: slugParam },
        props: { lang, routeKey },
      });
    });
  });

  // 2. Dynamische Blog Posts generieren
  for (const lang of languages) {
    const posts = await getPosts(lang);
    const isDefaultLang = lang === defaultLang;

    for (const post of posts) {
      const prefix = "blog";
      const slugParam = isDefaultLang
        ? `${prefix}/${post.slug}`
        : `${lang}/${prefix}/${post.slug}`;

      paths.push({
        params: { slug: slugParam },
        props: {
          lang,
          routeKey: "blog_detail",
          post: post,
        },
      });
    }
  }

  return paths;
}

const { lang, routeKey, post } = Astro.props;

const view = getView(routeKey, lang);
if (!view) {
  return Astro.redirect("/404");
}

const { Component, t } = view;

// SEO Daten vorbereiten
let title = t.seo?.title || "Beckernet";
let description = t.seo?.description || "";

// Wenn es ein Blog Post ist, Ã¼berschreiben wir SEO mit Post-Daten
if (post && post.translations[0]) {
  title = `${post.translations[0].title} | Becker`;
  description = post.translations[0].excerpt || "";
}
---

<Layout title={title} description={description} lang={lang} routeKey={routeKey}>
  <Component lang={lang} t={t} post={post} />
</Layout>
