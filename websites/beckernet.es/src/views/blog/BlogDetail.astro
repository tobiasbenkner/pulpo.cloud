---
import Container from "@/components/ui/Container.astro";
import { imageUrl } from "@/lib/cms";
import { resolveTranslations, type Language } from "@/lib/i18n";
import { getTranslatedPath } from "@/lib/registry";
import type { BlogPost, BlogPostCategory } from "@pulpo/cms";
import { Icon } from "astro-icon/components";
import { Image } from "astro:assets";
import { marked } from "marked";

type Props = {
  lang: Language;
  post: BlogPost;
  category: BlogPostCategory;
};

const { post, lang, category } = Astro.props;

// Routing
const categoryRouteKey = `blog_category_${category.id}`;
const categoryHref = getTranslatedPath(categoryRouteKey, lang);

// Ãœbersetzungen
const categoryT = resolveTranslations(category, lang);
const t = resolveTranslations(post, lang);
const contentHtml = t.content ? await marked.parse(String(t.content)) : "";

const dateStr = new Date(post.date).toLocaleDateString(lang, {
  year: "numeric",
  month: "long",
  day: "numeric",
});
---

<article class="pt-4 md:pt-8 pb-24 min-h-screen bg-background">
  <Container>
    <!-- 1. TOP NAV -->
    <div class="max-w-3xl mx-auto mb-8">
      <a
        href={categoryHref}
        class="inline-flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-text-muted hover:text-secondary transition-colors"
      >
        <Icon name="lucide:arrow-left" class="w-4 h-4" />
        <span>{categoryT.title}</span>
      </a>
    </div>

    <!-- 2. HEADER -->
    <header class="max-w-4xl mx-auto text-center mb-10">
      <div
        class="flex items-center justify-center gap-4 text-sm text-secondary font-bold tracking-widest uppercase mb-4"
      >
        <span>{dateStr}</span>
      </div>

      <h1
        class="text-3xl md:text-5xl lg:text-6xl font-serif text-white leading-tight text-balance"
      >
        {t.title}
      </h1>
    </header>

    {
      post.image && (
        <div class="max-w-3xl mx-auto mb-12">
          <div class="w-full overflow-hidden rounded-sm bg-surface border border-border/20 shadow-2xl">
            <Image
              src={imageUrl(post.image.id, 1000)}
              width={1000}
              height={1000}
              alt={String(t.title)}
              class="w-full h-auto block"
            />
          </div>
        </div>
      )
    }

    <!-- 4. CONTENT -->
    <div class="max-w-3xl mx-auto">
      <div
        class="prose prose-lg prose-invert max-w-none"
        set:html={contentHtml}
      />

      <!-- 5. BOTTOM NAV -->
      <div class="mt-16 pt-12 border-t border-border/40">
        <a href={categoryHref} class="inline-flex items-center gap-3 group">
          <div
            class="p-3 rounded-full border border-border bg-surface group-hover:border-secondary group-hover:bg-secondary transition-colors"
          >
            <Icon
              name="lucide:arrow-left"
              class="w-4 h-4 text-white group-hover:text-background"
            />
          </div>
          <div class="flex flex-col">
            <span
              class="text-lg font-serif text-white group-hover:text-secondary transition-colors"
              >{categoryT.title}</span
            >
          </div>
        </a>
      </div>
    </div>
  </Container>
</article>
